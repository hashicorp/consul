{{!
  Copyright (c) HashiCorp, Inc.
  SPDX-License-Identifier: BUSL-1.1
}}

<AuthDialog
  @src={{uri "settings://consul:token"}}
  @sink={{uri "settings://consul:token"}}
  @onchange={{this.reauthorize}}
>
  <:unauthorized as |authDialog|>

    <ModalDialog
      @name="login-toggle"
      @onclose={{this.close}}
      @onopen={{this.open}}
      @aria={{hash label="Log in to Consul"}}
      as |modal|
    >
      <Ref @target={{this}} @name="modal" @value={{modal}} />
      <BlockSlot @name="header">
        <h2>
          Log in to Consul
        </h2>
      </BlockSlot>
      <BlockSlot @name="body">
        <AuthForm
          @dc={{@dc.Name}}
          @partition={{@partition}}
          @nspace={{@nspace}}
          @onsubmit={{action authDialog.login value="data"}}
          as |authForm|
        >
          <Ref @target={{this}} @name="authForm" @value={{authForm}} />
          {{#if (can "use SSO")}}
            <authForm.Method @matches="sso">
              <OidcSelect
                @dc={{@dc.Name}}
                @partition={{@partition}}
                @nspace={{@nspace}}
                @disabled={{authForm.disabled}}
                @onchange={{authForm.submit}}
                @onerror={{authForm.error}}
              />
            </authForm.Method>
          {{/if}}
        </AuthForm>
      </BlockSlot>
      <BlockSlot @name="actions">
        <Hds::Button
          @color="secondary"
          @text="Continue without logging in"
          {{on "click" modal.close}}
        />
      </BlockSlot>
    </ModalDialog>

    <Hds::Dropdown class="hds-side-nav__dropdown" @listPosition="left" as |dd|>

      <dd.ToggleIcon @icon="user" @text="Account menu" />
      <dd.Interactive
        @href={{href-to
          "settings"
          params=(hash nspace=undefined partition=undefined)
        }}
        @text="Settings"
        @isHrefExternal={{false}}
      />
      <dd.Interactive
        @text="Sign in"
        {{on "click" (optional this.modal.open)}}
      />
    </Hds::Dropdown>
  </:unauthorized>
  <:authorized as |authDialog|>

    <ModalDialog
      @name="login-toggle"
      @onclose={{this.close}}
      @onopen={{this.open}}
      @aria={{hash label="Log in with a different token"}}
      as |modal|
    >
      <Ref @target={{this}} @name="modal" @value={{modal}} />
      <BlockSlot @name="header">
        <h2>
          Log in with a different token
        </h2>
      </BlockSlot>
      <BlockSlot @name="body">
        <AuthForm
          @dc={{@dc.Name}}
          @nspace={{@nspace}}
          @partition={{@partition}}
          @onsubmit={{action authDialog.login value="data"}}
          as |authForm|
        >
          <Ref @target={{this}} @name="authForm" @value={{authForm}} />
        </AuthForm>
      </BlockSlot>
      <BlockSlot @name="actions">
        <Hds::Button
          @color="secondary"
          @text="Continue without logging in"
          {{on "click" modal.close}}
        />
      </BlockSlot>
    </ModalDialog>

    <Hds::Dropdown class="hds-side-nav__dropdown" @listPosition="left" as |dd|>
      <dd.ToggleIcon @icon="user" @text="Account menu" />
      {{#if authDialog.token.AccessorID}}
        <dd.Title @text="Signed in with ACL Token" />
        <dd.Description
          @text={{string-substring
            authDialog.token.AccessorID
            (sub authDialog.token.AccessorID.length 8)
          }}
        />
      {{/if}}
      <dd.Separator />
      <dd.Interactive
        @href={{href-to
          "settings"
          params=(hash nspace=undefined partition=undefined)
        }}
        @text="Settings"
        @isHrefExternal={{false}}
      />
      <dd.Interactive
        @text="Sign out"
        {{on "click" (optional authDialog.logout)}}
      />
    </Hds::Dropdown>
  </:authorized>
</AuthDialog>
{{yield (hash open=this.modal.open close=this.model.close)}}