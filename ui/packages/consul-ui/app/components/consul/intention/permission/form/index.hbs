{{!
  Copyright (c) HashiCorp, Inc.
  SPDX-License-Identifier: BUSL-1.1
}}

<div
  ...attributes
  class="consul-intention-permission-form"
  {{fix-super-select-aria}}
>
<FormGroup
  @name={{this.name}}
as |group|>

  {{yield (hash
    submit=(action 'submit' this.changeset)
    reset=(action 'reset' this.changeset)

    isDirty=(and this.changeset.isValid)
    changeset=this.changeset
  )}}

  <fieldset>
    <div data-property="action">
      <span class="label">
        Should this permission allow the source connect to the destination?
      </span>
      <div role="radiogroup" class={{if this.changeset.error.Action ' has-error'}}>
        {{#each this.intents as |intent|}}
          <label>
            <span>{{capitalize intent}}</span>
            <input
              type="radio"
              name="Action"
              value={{intent}}
              checked={{if (eq this.changeset.Action intent) 'checked'}}
              onchange={{action (changeset-set this.changeset 'Action') value="target.value"}}
            />
          </label>
        {{/each}}
      </div>
    </div>
  </fieldset>

  <fieldset>
      <h2>Path</h2>
    <div>
        <group.Element
          @name="PathType"
          @type="select"
        as |el|>
          <el.Label>
            Path type
          </el.Label>
          <Hds::Form::SuperSelect::Single::Field
            @options={{this.pathTypes}}
            @selected={{this.pathType}}
            @onChange={{action 'change' 'HTTP.PathType' this.changeset}}
            @label="Path type"
            @listboxAriaLabel="Path type options"
            id="path-type-select"
          as |F|>
            <F.Options>{{get this.pathLabels F.options}}</F.Options>
          </Hds::Form::SuperSelect::Single::Field>
        </group.Element>

{{#if this.shouldShowPathField}}
        <group.Element
          @name="Path"
          @error={{changeset-get this.changeset 'error.HTTP.Path'}}
        as |el|>
          <el.Label>
            {{get this.pathLabels this.pathType}}
          </el.Label>
          <el.Text
            @value={{changeset-get this.changeset 'HTTP.Path'}}
            oninput={{action 'change' 'HTTP.Path' this.changeset}}
          />
          <State @state={{el.state}} @matches="error">
            <el.Error>
              {{#if (eq (changeset-get this.changeset 'HTTP.Path') 'Regex')}}
                Path Regex should not be blank
              {{else}}
                Path should begin with a '/'
              {{/if}}
            </el.Error>
          </State>
        </group.Element>
{{/if}}

    </div>
  </fieldset>

  <fieldset>
    <h2>Methods</h2>
    <div class="type-toggle">
      <span>All methods are applied by default unless specified</span>
      <group.Element
        @name="allMethods"
      as |el|>
        <el.Checkbox
          checked={{if this.allMethods 'checked'}}
          onchange={{action 'change' 'allMethods' this.changeset}}
        />
        <el.Label>
          All Methods
        </el.Label>
      </group.Element>
    </div>

{{#if this.shouldShowMethods}}
    <div class="checkbox-group" role="group">
      {{#each this.methods as |method|}}
        <label class="type-checkbox">
          <input
            type="checkbox"
            name="method"
            value={{method}}
            checked={{if (includes method this.changeset.HTTP.Methods) 'checked'}}
            onchange={{action 'change' 'method' this.changeset}}
          />
          <span>{{method}}</span>
        </label>
      {{/each}}
    </div>
{{/if}}
  </fieldset>

  <fieldset>
    <h2>Headers</h2>

    <Consul::Intention::Permission::Header::List
      @items={{changeset-get this.changeset 'HTTP.Header'}}
      @ondelete={{action 'delete' 'HTTP.Header' this.changeset}}
    as |headerList|>

    </Consul::Intention::Permission::Header::List>

    <Consul::Intention::Permission::Header::Form
      @onsubmit={{action 'add' 'HTTP.Header' this.changeset}}
    as |headerForm|>
      <Ref @target={{this}} @name="headerForm" @value={{headerForm}} />
    </Consul::Intention::Permission::Header::Form>

    <Hds::ButtonSet>
      <Hds::Button
        data-test-add-header
        @text='Add{{if (gt (get (changeset-get this.changeset 'HTTP.Header') 'length') 0) ' another' ''}} header'
        @color='primary'
        disabled={{if (not this.headerForm.isDirty) 'disabled'}}
        onclick={{action this.headerForm.submit}}
      />
      <Hds::Button
        @text='Cancel'
        @color='secondary'
        onclick={{action this.headerForm.reset}}
      />
    </Hds::ButtonSet>
  </fieldset>
  </FormGroup>
</div>