# Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: MPL-2.0

name: Trigger Community Edition to Enterprise Merge
on:
  pull_request_target:
    types:
      - closed
    branches:
      - main
      - release/**


jobs:
  trigger-ce-merge:
    # run this only on merge events in CE repo
    if: ${{ github.event.pull_request.merged && github.repository == 'hashicorp/consul' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Fetch active releases
        id: active
        run: |
          IS_ACTIVE=1
          if [[ -f ./.release/versions.hcl ]]; then
            ACTIVE=$(awk '/version "[0-9]+\.[0-9]+"/{ver=$2} /ce_active = true/{print ver}' ./.release/versions.hcl | tr -d '"')
            echo "Active versions: $ACTIVE"
            IS_ACTIVE=0
            for v in $ACTIVE; do
              if [[ "$BRANCH" == "release/$v"* ]]; then IS_ACTIVE=1; fi
            done
            if [[ "$BRANCH" == "main" ]]; then IS_ACTIVE=1; fi
          else
            echo ".release/versions.hcl not found, defaulting active=1"
          fi
          echo "active=$IS_ACTIVE" >> $GITHUB_OUTPUT
      - name: Get Approving Reviewers
        id: reviewers
        continue-on-error: true
        env:
          GH_PAT: ${{ secrets.ELEVATED_GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          reviewers=$(curl -s -H "Authorization: token $GH_PAT" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews" | \
            jq '[.[] | select(.state=="APPROVED") | .user.login] | unique | @json')
          echo "approved_reviewers=$reviewers" >> $GITHUB_OUTPUT
          echo "Approved reviewers: $reviewers"
      - name: Trigger Merge
        if: steps.active.outputs.active == '1'
        env:
          GIT_REF: ${{ github.ref_name }}
          GIT_SHA: ${{ github.sha }}
          GH_PAT: ${{ secrets.ELEVATED_GITHUB_TOKEN }}
          GIT_ACTOR: ${{ github.actor }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_APPROVERS: ${{ steps.reviewers.outputs.approved_reviewers }}
        run: |
          curl -H "Authorization: token $GH_PAT" \
            -H 'Accept: application/json' \
            -d "{\"event_type\": \"oss-merge\", \"client_payload\": {\"git-ref\": \"${GIT_REF}\", \"git-sha\": \"${GIT_SHA}\", \"git-actor\": \"${GIT_ACTOR}\", \"title\": \"${PR_TITLE}\", \"description\": \"${PR_BODY}\", \"pr_approvers\": ${PR_APPROVERS} }}" \
            "https://api.github.com/repos/hashicorp/consul-enterprise/dispatches"