name: frontend

on:
  pull_request:
    branches:
      - main
      # - /^ui\/.*/
      # - /^backport\/ui\/.*/
  push:
    branches:
      - main
      # - /^ui\/.*/
      # - /^backport\/ui\/.*/

jobs:
  frontend-cache:
    runs-on: ubuntu-20.04
    container:
      image: docker.mirror.hashicorp.services/circleci/node:16-browsers
    steps:
    - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # pin@v3.3.0

    - name: install yarn packages
      run: cd ui && make deps

    # saves the build artifacts to be passed to a downstream job
    - uses: actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce # pin@v3.1.2
      with:
        retention-days: 1
        name: node_modules
        path: |
          ui/node_modules
          ui/packages/consul-ui/node_modules

  workspace-tests:
    needs: frontend-cache
    runs-on: ubuntu-20.04
    container:
      image: docker.mirror.hashicorp.services/circleci/node:16-browsers
    defaults:
      run:
        working-directory: ui
    steps:
    - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # pin@v3.3.0
    - uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # pin@v3.0.2
      with:
        name: node_modules
    - run: ls -al # debug
    - run: make test-workspace

  node-tests:
    needs: frontend-cache
    runs-on: ubuntu-20.04
    container:
      image: docker.mirror.hashicorp.services/circleci/node:16-browsers
    defaults:
      run:
        working-directory: ui/packages/consul-ui
    steps:
    - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # pin@v3.3.0
    - uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # pin@v3.0.2
      with:
        name: node_modules
    - run: ls -al # debug
    - run: make test-node

  ember-build-test-oss:
    needs: frontend-cache
    runs-on: ubuntu-20.04
    container:
      image: docker.mirror.hashicorp.services/circleci/node:16-browsers
    defaults:
      run:
        working-directory: ui/packages/consul-ui
    env:
      EMBER_TEST_REPORT: test-results/report-oss.xml #outputs test report for CircleCI test summary
      EMBER_TEST_PARALLEL: true #enables test parallelization with ember-exam
      CONSUL_NSPACES_ENABLED: 0
    steps:
    - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # pin@v3.3.0
    - uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # pin@v3.0.2
      with:
        name: node_modules
    - run: ls -al # debug
    - run: make build-ci
    - run: node_modules/.bin/ember exam --path dist --silent -r xunit
