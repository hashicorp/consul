# Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: MPL-2.0

name: frontend

on:
  pull_request:
  push:
    branches:
      - main
      - ui/**
      - backport/ui/**

jobs:
  workspace-tests:
    runs-on: ubuntu-20.04
    container:
      image: docker.mirror.hashicorp.services/circleci/node:16-browsers
      options: --user root
    defaults:
      run:
        working-directory: ui
    steps:
    - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # pin@v3.3.0

    # Install dependencies.
    - name: install yarn packages
      working-directory: ui
      run: make deps

    - run: make test-workspace

  node-tests:
    runs-on: ubuntu-20.04
    container:
      image: docker.mirror.hashicorp.services/circleci/node:16-browsers
      options: --user root
    steps:
    - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # pin@v3.3.0

    # Install dependencies.
    - name: install yarn packages
      working-directory: ui
      run: make deps

    - run: make test-node
      working-directory: ui/packages/consul-ui

  ember-build-test:
    runs-on: ubuntu-20.04
    container:
      image: docker.mirror.hashicorp.services/circleci/node:16-browsers
      options: --user root
    env:
      EMBER_TEST_REPORT: test-results/report-oss.xml #outputs test report for CircleCI test summary
      EMBER_TEST_PARALLEL: true #enables test parallelization with ember-exam
      CONSUL_NSPACES_ENABLED: 0 # NOTE: this should be 1 in ENT.
    steps:
    - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # pin@v3.3.0

    # Install dependencies.
    - name: install yarn packages
      working-directory: ui
      run: make deps
    
    - working-directory: ui/packages/consul-ui
      run: |
        make build-ci
        node_modules/.bin/ember exam --path dist --silent -r xunit

    - working-directory: ui/packages/consul-ui
      run: make test-coverage-ci
