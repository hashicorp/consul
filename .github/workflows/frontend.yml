name: frontend

on:
  pull_request:
    branches:
      - main
      # - /^ui\/.*/
      # - /^backport\/ui\/.*/
  push:
    branches:
      - main
      # - /^ui\/.*/
      # - /^backport\/ui\/.*/

jobs:
  workspace-tests:
    runs-on: ubuntu-20.04
    container:
      image: docker.mirror.hashicorp.services/circleci/node:16-browsers
      options: --user root
    defaults:
      run:
        working-directory: ui
    steps:
    - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # pin@v3.3.0

    # Install dependencies.
    - name: install yarn packages
      run: cd ui && make deps

    - run: make test-workspace

  node-tests:
    runs-on: ubuntu-20.04
    container:
      image: docker.mirror.hashicorp.services/circleci/node:16-browsers
      options: --user root
    defaults:
      run:
        working-directory: ui/packages/consul-ui
    steps:
    - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # pin@v3.3.0

    # Install dependencies.
    - name: install yarn packages
      run: cd ui && make deps

    - run: make test-node

  ember-build-test-oss:
    runs-on: ubuntu-20.04
    container:
      image: docker.mirror.hashicorp.services/circleci/node:16-browsers
      options: --user root
    defaults:
      run:
        working-directory: ui/packages/consul-ui
    env:
      EMBER_TEST_REPORT: test-results/report-oss.xml #outputs test report for CircleCI test summary
      EMBER_TEST_PARALLEL: true #enables test parallelization with ember-exam
      CONSUL_NSPACES_ENABLED: 0
    steps:
    - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # pin@v3.3.0

    # Install dependencies.
    - name: install yarn packages
      run: cd ui && make deps
    
    - run: make build-ci
    - run: node_modules/.bin/ember exam --path dist --silent -r xunit
