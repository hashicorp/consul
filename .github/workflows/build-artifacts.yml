# Copyright (c) HashiCorp, Inc.
# SPDX-License-Identifier: MPL-2.0

name: build-artifacts

on: 
  # TODO: only on push to main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  dev-build-push:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c # pin@v3.3.0
    - uses: actions/setup-go@6edd4406fa81c3da01a34fa6f6343087c207a568 # pin@v3.5.0
      with:
        go-version-file: 'go.mod'
    - name: Dev Build
      run: make dev

    # Set env vars
    - run: |
        echo "SHORT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
        echo "GITHUB_BUILD_URL=${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_ENV

    - name: Login to Docker Hub
      uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a # pin@v2.1.0
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Docker build and push
      uses: docker/build-push-action@3b5e8027fcad23fda98b2e3ac259d8d67585f671 # pin@v4.0.0
      with:
        context: ./bin
        file: ./build-support/docker/Consul-Dev.dockerfile
        push: true
        # TODO: hashicorpdev/consul:latest
        tags: |
          hashicorpdev/consul:${{ env.SHORT_SHA }}
        labels: |
          COMMIT_SHA=${{ github.sha }}
          GITHUB_BUILD_URL=${{ env.GITHUB_BUILD_URL }}
