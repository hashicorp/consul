#!/bin/sh

set -e

tempfile=$(mktemp)
echo "==> Generating schema map..."

# Collect constants into a temporary file
find ../../consul/agent/consul/state/ -type f -name '*.go' | while read -r file; do
  awk '
  BEGIN { FS = "="; inConstBlock = 0; }
  /const \(/ { inConstBlock = 1; }
  /\)/ && inConstBlock { inConstBlock = 0; next; }
  inConstBlock && /^[\t ]*table/ && !/tableIndex|tableUsage/ {
    gsub(/"/, "", $2);
    gsub(/^[\t ]+|[\t ]+$/, "", $1);
    gsub(/^[\t ]+|[\t ]+$/, "", $2);
    print "\t" $1 " = \"" $2 "\"";
  }
  !inConstBlock && /^const[\t ]+table/ && !/tableIndex|tableUsage/ {
    split($0, parts, "=");
    gsub(/^const[\t ]+/, "", parts[1]);
    gsub(/"/, "", parts[2]);
    gsub(/^[\t ]+|[\t ]+$/, "", parts[1]);
    gsub(/^[\t ]+|[\t ]+$/, "", parts[2]);
    print "\t" parts[1] " = \"" parts[2] "\"";
  }' "$file" >> "$tempfile"
done

# Generate the final file with sorted constants
{
  echo "// Code generated by script; DO NOT EDIT."
  echo "package raftutil"
  echo ""
  echo "const ("
  sort "$tempfile"
  echo ")"
} > schemamap.go

# Clean up
rm "$tempfile"

echo "==> Formatting schema map..."
gofmt -w schemamap.go
