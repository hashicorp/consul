#!/bin/sh

set -e

output="schemamap.go"
tmp_names=$(mktemp)

# Initialize the output file
echo "// Code generated by script; DO NOT EDIT." > "$output"
echo "package raftutil" >> "$output"
echo "" >> "$output"
echo "// TableName is a custom data type for table names." >> "$output"
echo "type TableName string" >> "$output"
echo "" >> "$output"
echo "const (" >> "$output"

# Extract table names and generate constants
find ../../consul/agent/consul/state/ -type f -name '*.go' |
while read -r file; do
  awk -v outfile="$output" -v tmpfile="$tmp_names" '
    BEGIN { FS = "="; inConstBlock = 0; }
    /const \(/ { inConstBlock = 1; }
    /\)/ && inConstBlock { inConstBlock = 0; }
    inConstBlock && /^[\t ]*table/ && !/tableIndex|tableUsage/ {
      gsub(/"/, "", $2);
      gsub(/^[\t ]+|[\t ]+$/, "", $1);
      gsub(/^[\t ]+|[\t ]+$/, "", $2);
      print "\t" $1 " TableName = \"" $2 "\"";
      print $1 >> tmpfile;
    }' "$file" >> "$output"
done

echo ")" >> "$output"  # Close the const block

# Sort and remove duplicate table names, then generate the TableName slice
echo "" >> "$output"
echo "// AllTableNames holds all table names." >> "$output"
echo "var AllTableNames = []TableName{" >> "$output"

while read -r name; do
  echo "  $name," >> "$output"
done < "$tmp_names"

echo "}" >> "$output"  # Close the slice

# Clean up
rm "$tmp_names"

# Format the generated Go code
gofmt -s -w "$output"
echo "Generation complete. Formatted $output successfully."
