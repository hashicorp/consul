#!/bin/bash

set -euo pipefail
unset CDPATH

cd "$(dirname "$0")" # build-support/scripts
cd ../..             # <ROOT>

if [[ ! -f GNUmakefile ]] || [[ ! -f go.mod ]]; then
    echo "not in root consul checkout: ${PWD}" >&2
    exit 1
fi

readonly LIBRARY_VERSION="$(grep github.com/envoyproxy/go-control-plane go.mod | awk '{print $2}')"
readonly OUTFILE=z_xds_packages.go

echo "Fetching envoyproxy/go-control-plane @ ${LIBRARY_VERSION}..."

rm -rf _envoy_tmp
mkdir _envoy_tmp
trap "rm -rf _envoy_tmp" EXIT
(
cd _envoy_tmp

git clone git@github.com:envoyproxy/go-control-plane
cd go-control-plane
git co -b consul-temp "${LIBRARY_VERSION}"

IFS=$'\n' candidates=($(find . -name *.pb.go -a -type f | sed 's@/[^/]*\.pb\.go$@@' | sort -u))

echo "Generating a fresh ${OUTFILE} file..."
cat <<-EOF > "${OUTFILE}"
// Code generated by envoy-library-references.sh. DO NOT EDIT.

package xds

import (
EOF

for cand in "${candidates[@]}"; do
    import_name="${cand#./}"
    echo "	_ \"github.com/envoyproxy/go-control-plane/${import_name}\"" >> "${OUTFILE}"
done

echo ")" >> "${OUTFILE}"

goimports -w "${OUTFILE}"

mv -f "${OUTFILE}" ../../agent/xds
)

echo "updating vendored code..."
make update-vendor
