---
layout: "docs"
page_title: "Jepsen Testing in Consul, 2019 Update"
sidebar_current: "docs-internals-jepsen"
description: |-
  FIXME Don't remove this and create a description until all other FIXME and TODO are fixmed and todone
  TODO Port every code link to commits rather than linking to github master :'(
---

# FIXME(content) Jepsen Testing in Consul, 2019 Update

NOTE This is probably better in just the blog post. Website documentation has a significantly different voice, I believe.
## FIXME(content) Intoduction
  I'm a contributing author for [Jepsen](https://jepsen.io) and a major contributor to both the [Jepsen library](https://github.com/jepsen-io/jepsen) and the [Knossos linearizability checker](https://github.com/jepsen-io/knossos). In December of 2019, I joined the Consul Core team as a Senior Software Engineer to build and rigoriously verify all of that networked, distributed goodness.

Right away, I dug into Consul's [jepsen tests from 2014](TODO LINK). In this blog post, we're going to explore Consul's Jepsen test suite and recent work to improve it. The changes themselves were mostly structural improvements, we don't add much to _what_ is being tested, mostly just improving how we do it. Given that these changes make a lot of room for future improvements, we're going to focus this article on how jepsen works.

But first, let's discuss the system under test. [HashiCorp Consul](https://consul.io) is an open source tool that provides service discovery, health checking, load balancing, and a globally distributed key-value store. Consul is a large distributed system, providing all of its core functionality over networks, whether as traffic between servers, health checking services, or serving requests on its state to clients. It's well understood that [networks are not reliable](https://aphyr.com/posts/288-the-network-is-reliable) and distributed systems are [notoriously difficult to implement correctly](). With so many concurrently running processes, there's a large surface area for unexpected behavior to occur.

(FIXME awk) Consul uses a combination of raft and serf (and more?) as the backbone for many of its features

One of the ways that Consul ensures the consistency of its responses, is to use the consensus alorgithm [Raft](https://github.com/hashicorp/raft) to solve various problems arising from [consensus](https://www.consul.io/docs/internals/consensus.html) (FIXME Awkward, not technical enough) 

  - What features are built on top of the FSM?
    - Key/value store, locks, txns?, configuration?, ETC. (big review needed, look at consensus and go through the codebase for FSM usage)
  - the jepsen testing one of the foundations of Consul: its strongly consistent storage layer: Raft.

- Why do Jepsen tests?
  - [Consul's jepsen suite](https://github.com/jepsen-io/jepsen/tree/master/consul),
  - Jepsen testing is a lot like security testing. Only, instead of testing a system against a malicious actor, you test it against environmental factors that are otherwise difficult to test for.
  - To do so, we test an actual running system by generating load while injecting faults at a system (clocks), network (partitions), process(pause, kill, restart), and application (membership change) levels.
  - This makes jepsen testing complementary to practices like unit and integration testing.
  - Consul's exploration of [consistency modes](https://www.consul.io/api/features/consistency.html) were brought about from [jepsen testing](TODO Link to call me maybe etcd-consul). Consul _clearly documents_ the case where stale reads can occur after a leadership trasition has occurred.

  We'll explain what Jepsen testing is all about, prior jepsen testing performed by the Consul team, how the tests work, what's new, how Consul has fared given the update, and what future work remains.

  It's important to note that, while I have worked with database vendors and Jepsen, LLC as an indepedent researcher in (2017-2019), and [published a formal Jepsen analysis](http://jepsen.io/analyses/mongodb-3-6-4), this is **NOT** an offical Jepsen report. Official Jepsen analyses are performed as an indepedent entity, in accordance with the [Jepsen Ethics Policy](https://jepsen.io/ethics), and verified by Kyle Kingbury (aphyr). Though I follow Jepsen's research ethics policy to the best of my ability in this and prior work, as an employee of HashiCorp I have an unambiguous and direct conflict of interest. Therefore, readers of this article **must not** consider this a substitute for an offical Jepsen [analysis](http://jepsen.io/analyses) on Consul.

## FIXME(content) What is Jepsen testing?
  [Jepsen](http://jepsen.io/#about-jepsen) testing started back in 2013 (?) to test the reliability of distributed systems and strongly influenced popular databases in use today. (TODO How? MongoDB, Elasticsearch, etc.) It started as a [testing library](https://github.com/jepsen-io/jepsen) by Kyle Kingsbury to test that the behavior of distributed systems, for example: databases, queues, locking services, consensus systems, etc., match the expectations vendors offer to their users in documentation and promotional material.  Especially under load and the kinds of adverse conditions (like network partitions, system clock instability, and unexpected changes in cluster membership) that were known to occur (TODO Link to Peter Bailis article) but for which testing options lacked at the time. Over the years, Jepsen has grown into an LLC offering indepedent research and training, and as a destination for readers to understand distributed systems in use today through their portfolio of [analyses](http://jepsen.io/analyses), and learn more about their properties through resources like [talks](http://jepsen.io/talks) and articles on the field of distributed systems verification, such as the [consistency graph and explanations](http://jepsen.io/consistency).

  Jepsen testing matters, because it means that databases keep the promises about the behavior of their databases that they make to their users.
  
  
## FIXME(outline) Consul's Jepsen Tests
### FIXME(Outline) History
  Five and a half years ago, the early Consul team did a rare thing in the industry at the time: they elected to [write their own Jepsen tests](TODO link to jepsen2014). Even rarer, their results turned out pretty well! Adding consistency levels (todo link to docs mentioned in the blog post)
    - [Test and results](https://aphyr.com/posts/316-call-me-maybe-etcd-and-consul)
  - Previous version of the docs (maybe move them to a new page, link to it in the new release post)

### FIXME(outline) What is a Register test?
  - A register test is a way of checking that a history of operations can be linearized. We continue exploring sections of operations until we find a path through them that can be linearized. If none can be found and all expensive paths are explored, then we can safely say that a history is not valid.
  - TODO Draw a diagram of what a linearizable result looks like.
  - TODO Diagram of what a nonlinearizable result looks like e.g. (grab something out of linear.png? when running consul without strong consistency)
  -  ops that clients know how to handle. This appends into our `history`, and then we pass the history to our linear `checker`, [Knossos](https://github.com/jepsen-io/knossos) which ensures the keys are linearizable.
  - TODO Diagram of an independent register.

### FIXME(proofing) What did we change?
  After five and a half years, the old test suite got a bit dusty and didn't run anymore. So, we started by bumping the test version up to [Jepsen v0.1.15](https://github.com/jepsen-io/jepsen/blob/master/consul/project.clj#L7). We rewrote the test runner to accept a spec of [CLI args](https://github.com/jepsen-io/jepsen/blob/master/consul/src/jepsen/consul.clj#L58) and we can now implement tests (like register) as [workloads](https://github.com/jepsen-io/jepsen/blob/master/consul/src/jepsen/consul.clj#L15). Workloads allow us to run sets of tests at once (or no tests at all) by specifying which, e.g. `--workload register`. This is useful in all contexts of running and developing a test suite. We also paramaterized [different release versions of Consul](https://github.com/jepsen-io/jepsen/blob/master/consul/src/jepsen/consul/db.clj#L58) All of the tests for this post were run against [Consul v1.6.1](https://github.com/jepsen-io/jepsen/blob/master/consul/src/jepsen/consul.clj#L61).

Once we'd upgraded the structure of the tests to fit jepsen's newer abstractions, we double checked all the behavior of the previous register test implementation. While most of the previous tests were still valid, we found a various places to improve the stictness of the tests. First, we fixed a [bug](https://github.com/jepsen-io/jepsen/commit/db24fac7c68c3283b9c2c20e742fa508268ab07e#diff-f5e04f13dad45e9e80332ddce9d754e8R57) with the register test's `client` that prevented CAS (compare-and-swap) operations from ever being completed. We also ported the register test's generator to [jepsen.independent/concurrent-generator](https://github.com/jepsen-io/jepsen/commit/19b085f49471abffb57fa240021a15640d0005a5#diff-71833489f38c369aa9ca5454002fe061R64) to raise the thoughput significantly by writing to [multiple keys in parallel](http://jepsen-io.github.io/jepsen/jepsen.independent.html#var-concurrent-generator) with 10 threads per key. This also speeds up and reduces the memory footprint of the checker by subdividing the state space that [Knossos' two competing implementations](https://github.com/jepsen-io/knossos/blob/master/src/knossos/competition.clj#L18-L19) have to explore. Linearizability checking is NP-hard as is, so we can't catch every possible violation every time. However, violations over very long time periods (think, multiple minutes) are rare, and we must take various tradeoffs are taken into account to make linear checking practical on current hardware.

## FIXME Outcomes
### FIXME(content!) Results
Based on weeks of testing against the updated register workload, we're happy to announce that Consul continues to pass its jepsen test suite! While there's certainly more workloads besides the register  to explore (see Future Work below), after five and a half years and a much higher throughput, stricter test, Consul appears to continue to implement hashicorp/Raft correctly. TODO (double check this) There are also no known consistency issues with Consul's consensus system or hashicorp/raft at this time.
```
Everything looks good! ヽ(‘ー`)ノ
```
(Well, at least everything we've checked so far!)

- TODO Include images/embeds of individual test results, with rate and latency graphsj
- TODO S3 downloads for sets of test results

- TODO Double check that we're configured for strong consistency If so, check behavior without strong consistency enabled as a control


### FIXME(proofing) Future Work
This has been a side project and no additional work is scheduled yet. However, there is much more work we can do to more strictly verify Consul and other HashiCorp products, such as Vault and Nomad, that utilize consensus. There are more [tests](https://github.com/jepsen-io/jepsen/tree/master/jepsen/src/jepsen/tests) that we can implement as additional workloads. For example, append-only set tests are quick and simple to verify broad regressions when run in CI. While more strict tests like [lock](https://github.com/jepsen-io/etcd/blob/master/src/jepsen/etcd/lock.clj), [watch](https://github.com/jepsen-io/etcd/blob/master/src/jepsen/etcd/watch.clj), [bank](https://github.com/jepsen-io/jepsen/blob/master/jepsen/src/jepsen/tests/bank.clj), [cycle](https://github.com/jepsen-io/jepsen/blob/master/jepsen/src/jepsen/tests/cycle.clj), [causal-reverse](https://github.com/jepsen-io/jepsen/blob/master/jepsen/src/jepsen/tests/causal_reverse.clj) (and more!) tests can check additional behavior in Consul that we haven't yet explored and verified in our Jepsen suite.

In addition to more workloads, there are more [nemeses than network partitions](https://github.com/jepsen-io/etcd/blob/master/src/jepsen/etcd/nemesis.clj) that we can bring in and compose into nemesis packages. There exist nemeses that can pause, kill, and restart consul processes, induce membership changes and pathologically alter system clocks.

Also, we may yet find bugs by exploring the large state space of Consul's configuration options. Right now, we test Consul under [default paramters](https://github.com/jepsen-io/jepsen/blob/master/consul/src/jepsen/consul/db.clj#L31) doing very little besides starting an agent as a server. With options for users to adjust timeouts and various other paramters, there's lots more for the Consul Core team to explore, verify, and document. In the future, we may [construct a config.hcl file from CLI params](https://github.com/jepsen-io/jepsen/blob/master/consul/src/jepsen/consul/db.clj#L65) exposing more configuration options to the jepsen test suite.

   In addition to enhancements to the test suite itself, there's the possibility to integrate Jepsen tests more closely in Consul's development workflow via our continuous integration (CI) pipeline. Other database vendors run their jepsen suites nightly and/or weekly to look for regressions in the primary working branch. As we add more workloads of varying complexity and strictness, we can tune how often these run. (Waiting for a full linear test every single commit is not necessarily practical.) As we expand our testing practices to test backwards compatability, TODO (envoy, vault) we can test mulitple releases of Consul itself now that we've parameterized the version of Consul we download.

  Finally, there's been some discussion of testing other HashiCorp products' use of Raft, e.g. Nomad and Vault's. Linearizable systems are not guaranteed to compose, so it's important to test both the library itself (Raft) and a system's usage of Raft. As our suite of fault-injecting model checking tests continue to grow at HashiCorp, you can expect additional posts examining the technical details of these approaches.

NOTE This is probably better in just the blog post. Documents have a different voice, I believe.
## FIXME(proofing) Conclusion
  As you can see, there's lots to be excited about with Jepsen testing and Consul. We hope you've learned a lot about verifying distributed systems, and piqued your interest for both Consul and other HashiCorp products. FIXME This feels super canned
