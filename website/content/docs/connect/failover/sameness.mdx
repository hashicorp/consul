---
layout: docs
page_title: Failover with sameness groups
description: You can configure sameness groups so that when a service instance fails, traffic automatically routes to an identical service instance. Learn how to use sameness groups to create a failover strategy for deployments with multiple datacenters and cluster peering connections.
---

# Failover with sameness groups

This page describes how to use sameness groups to automatically redirect service traffic to healthy instances in failover scenarios. Sameness groups are a user-defined set of Consul admin partitions with identical registered services. These admin paritions typically belong to Consul datacenters in different cloud regions, which enables sameness groups to participate in several service failover configuration strategies.

To create a sameness group and configure each Consul datacenter to allow traffic from other members of the group, refer to [create sameness groups](/consul/docs/connect/cluster-peering/usage/create-sameness-groups).

## Failover strategies

You can edit a sameness group configuration entry so that all services failover to healthy instances on other members of a sameness group by default. You can also reference the sameness group in other configuration entries to enact other failover strategies with your strategies. 

You can establish a failover strategy by configuring sameness group behavior in the following locations:

- Sameness group configuration entry
- Service resolver configuration entry
- Prepared queries

### Failover with a sameness group configuration entry

To define failover behavior using a sameness group configuration entry, set `DefaultForFailover=true` and apply the updated configuration to all clusters that are members of the group.

When `DefaultForFailover=true`, Consul attempts to redirect traffic to healthy instances according to the order of the group `Members` in the configuration entry. When you set `IncludeLocal=true` in the sameness group configuration entry, Consul attempts to redirect traffic to another instance in the same admin partition before redirecting to other group members.

In the following example, datacenter `dc1` has two partitions, `partition-1` and `partition-2`. A second datacenter, `dc2`, has a single partition named `partition-1`. All three partitions have identically configured services and established cluster peering connections. The configuration entry defines a sameness group, `example-sg` in `dc1`. When redirecting traffic during a failover scenario, Consul will attempt to find a healthy instance in a specific order: `dc1-partition-1`, then `dc-1-partition-2`, then `dc2-partition-1`.

<Tabs>

<Tab heading="HCL" group="hcl">

```hcl
Kind                     = "sameness-group"  
Name                     = "example-sg"
Partition                = "partition-1" 
DefaultForFailover       = true
IncludeLocal             = true
Members                = [
      {Partition = "partition-1"},
      {Partition = "partition-2"},
      {Peer      = "dc2-partition-1"}
      ]
```

</Tab>

<Tab heading="JSON" group="json">

```
{
    "Kind": "sameness-group", 
    "Name": "example-sg", 
    "Partition": "partition-1",
    "DefaultForFailover": true,
    "IncludeLocal": true,
    "Members": [
        {
            "Partition": "partition-1"
        },
        {
            "Partition": "partition-2"
        },
        {
            "Peer": "dc2-partition-1"
        }
    ]
}
```

<Tab heading="YAML" group="yaml">

```yaml
apiVersion: consul.hashicorp.com/v1alpha1
kind: SamenessGroup 
metadata:
  name: example-sg
spec:
  defaultForFailover: true
  includeLocal: true
  members:                                   
    - partition: partition1
    - partition: partition2
    - peer: dc2-partition1
```

</Tab>

When a sameness group is configured as the failover default, sameness group failover takes precedence over all other failover configurations in the cluster. You cannot choose subsets of services to use the sameness group for failover. All services registered in the admin partition must failover to another member of the sameness group. If groups do not have identical services, or if a service is registered to some group members but not all members, this failover strategy may produce errors.

For more information about specifying sameness group members and failover, refer to [sameness group configuration entry reference](/consul/docs/connects/config-entries/sameness-group).

### Failover with a service resolver configuration entry

<Tabs>

<Tab heading="HCL" group="hcl">

```hcl
Kind          = "service-resolver"
Name          = "db"
DefaultSubset = "v1"
Subsets = {
  v1 = {
    Filter = "Service.Meta.version == v1"
  }
  v2 = {
    Filter = "Service.Meta.version == v2"
  }
}
Failover {
  v1 = {
    SamenessGroup = "local"
  }
  v2 = {
    Service = "another-service"
  }
}
```

</Tab>
</Tabs>

### Failover with a prepared query


```json
{
  "Name": "query-1",
  "Service": {
    "Service": "db",
    "SamenessGroup": "local",
    "Partition": "ap1",
    "Namespace": "ns1"
  }
}
```