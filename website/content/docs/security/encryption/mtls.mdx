---
layout: docs
page_title: mTLS Encryption
description: >-
  Consul supports encrypting all of its network traffic. Remote Process Calls (RPCs) between client and server agents can be encrypted with TLS and authenticated with certificates.
---

# Mutual TLS (mTLS) Encryption

This topics describes how to enable Mutual TLS (mTLS) encryption on a Consul datacenter.

The content in this page is not referred to Consul service mesh mTLS encryption. For documentation about Consul service mesh Certification authority refer to [Service Mesh Certificate Authority](/consul/docs/connect/ca) documentation.


## RPC Encryption with TLS

Consul supports the use of TLS certificates to secure the traffic related to the `RCP`, `gRPC`, and `HTTP` communications and to verify the authenticity of servers and clients. To enable this, Consul requires that all clients and servers have key pairs that are generated by a single Certification Authority (CA). This should be a private CA, used only internally. 

Client and server authenticity is verified using the following parameters:

- [`verify_incoming`](/consul/docs/agent/config/config-files#tls_defaults_verify_incoming)
- [`verify_outgoing`](/consul/docs/agent/config/config-files#tls_defaults_verify_outgoing) 
- [`verify_server_hostname`](/consul/docs/agent/config/config-files#tls_default_verify_server_hostname)





## Initialize the built-in CA

The first step for configuring TLS for Consul is generating certificates. To prevent unauthorized datacenter access, Consul requires all certificates
be signed by the same Certification Authority (CA). This should be a _private_ CA and not a public one as any certificate signed by this CA will be allowed to communicate with the datacenter.

There are a variety of tools for creating and managing your own CA, like the [PKI secrets engine in Vault](/vault/docs/secrets/pki) or the [Terraform TLS provider](https://registry.terraform.io/providers/hashicorp/tls/latest/docs), but Consul ships with built-in TLS tools to create and manage certificates.

You can create the CA and certificates before starting Consul, as long as you have the Consul binary installed in your path.

```shell-session
$ consul tls ca create -domain=consul
==> Saved consul-agent-ca.pem
==> Saved consul-agent-ca-key.pem
```

The command generates two files, `<domain>-agent-ca.pem` and `<domain>-agent-ca-key.pem`. In this example the domain used to generate the certificates is the default one, `consul`.

The CA certificate, `consul-agent-ca.pem`, contains the public key necessary to validate Consul certificates and therefore must be distributed to **every** node
that runs a consul agent.

The CA key, `consul-agent-ca-key.pem`, will be used to sign certificates for Consul nodes and must be kept private. Possession of this key allows anyone to run Consul as a trusted server or generate new valid certificates for the datacenter and obtain access to all Consul data, including ACL tokens.

## Create server certificates

In order to authenticate Consul servers, servers are provided with a special certificate that contains `server.<domain>.<datacenter>` in the `Common Name` and in the `Subject Alternative Name`. If you enable [`verify_server_hostname`](/consul/docs/agent/config/config-files#tls_default_verify_server_hostname), only agents that provide such certificate are allowed to boot as a server.

Without `verify_server_hostname = true` an attacker could compromise a Consul client agent and restart the agent as a server in order to get access to all the
data in your datacenter! This is why server certificates are special, and only servers should have them provisioned.

<Note>

Server keys, like the CA key, must be kept private - they effectively allow access to all Consul data.

</Note>


Create a server certificate for datacenter `dc1` and domain `consul`, if your datacenter or domain is different, remember to use the appropriate flags.

<Tabs>
<Tab heading="Single Consul Datacenter">

```shell-session
$ consul tls cert create -server -dc=dc1 -domain=consul
==> WARNING: Server Certificates grants authority to become a
    server and access all state in the cluster including root keys
    and all ACL tokens. Do not distribute them to production hosts
    that are not server nodes. Store them as securely as CA keys.
==> Using consul-agent-ca.pem and consul-agent-ca-key.pem
==> Saved dc1-server-consul-0.pem
==> Saved dc1-server-consul-0-key.pem
```

</Tab>
<Tab heading="Federated Consul Datacenter">

A federated Consul environment requires the server certificate to include the names of all Consul datacenters that are within the federated environment.
  
The `-additional-dnsname` flag allows you to provide an additional DNS name for Subject Alternative Names. _localhost_ is always included. This flag may be provided multiple times.

Below is an example for a federated environment that contains two consul datacenters, `dc1` and `dc2`.

```shell-session
$ consul tls cert create -server -dc dc1 -domain=consul -additional-dnsname="server.dc2.consul"
==> WARNING: Server Certificates grants authority to become a
    server and access all state in the cluster including root keys
    and all ACL tokens. Do not distribute them to production hosts
    that are not server nodes. Store them as securely as CA keys.
==> Using consul-agent-ca.pem and consul-agent-ca-key.pem
==> Saved dc1-server-consul-0.pem
==> Saved dc1-server-consul-0-key.pem
```

</Tab>
</Tabs>

Repeat this process on the same node where you created the CA, until there is an _individual_ certificate for each server. The command can be called over and over again, it will automatically increase the certificate and key numbers. You will need to distribute the certificates to the servers.

### Distribute the server certificates

After generating the server certificates, you will need to distribute them to the Consul servers and put their on-disk location in the agent configuration file.

The following files need to be copied to your Consul server:

- `consul-agent-ca.pem`: CA public certificate.
- `dc1-server-consul-0.pem`: Consul server node public certificate for first server node in the `dc1` datacenter in the `consul` domain.
- `dc1-server-consul-0-key.pem`: Consul server node private key for first server node in the `dc1` datacenter in the `consul` domain.

## Configure server agents

There are two methods for configuring Consul server agents depending on the way you want to distribute certificates to the client agents: 
- auto encryption method, that uses the Consul Connect CA to generate client certificates, which are automatically distributed to all Consul clients.
- operator method, that requires you to manually generate client certificates and distribute them to the single client agents.

We recommend the auto-encryption method to alleviate the client certificate generation and distribution step for operators. Using auto-encryption the client certificates will also be automatically rotated without the need for an operator intervention.

Use the operator method if you need to use a third-party CA or need more fine-grained control over certificate management. 

<Tabs>
<Tab heading="Auto-encryption method" group="auto">

<CodeTabs>

```hcl
addresses = {
  https = "0.0.0.0"
}
ports {
  https = 8501
}
tls {
  defaults {
    ca_file = "consul-agent-ca.pem"
    cert_file = "dc1-server-consul-0.pem"
    key_file = "dc1-server-consul-0-key.pem"
    verify_incoming = true
    verify_outgoing = true
    verify_server_hostname = true
  }
}
auto_encrypt {
  allow_tls = true
}
```

```json
{
  "addresses": {
    "https": "0.0.0.0"
  },
  "ports": {
    "https": 8501
  },
  "tls": {
    "defaults": {
      "ca_file": "consul-agent-ca.pem",
      "cert_file": "dc1-server-consul-0.pem",
      "key_file": "dc1-server-consul-0-key.pem",
      "verify_incoming": true,
      "verify_outgoing": true,
      "verify_server_hostname": true
    }
  },
  "auto_encrypt" : {
    "allow_tls" : true
  }
}
```

</CodeTabs>

</Tab>
<Tab heading="Operator method" group="manual">

<CodeTabs>

```hcl
addresses = {
  https = "0.0.0.0"
}
ports {
  https = 8501
}
tls {
  defaults {
    ca_file = "consul-agent-ca.pem"
    cert_file = "dc1-server-consul-0.pem"
    key_file = "dc1-server-consul-0-key.pem"
    verify_incoming = true
    verify_outgoing = true
    verify_server_hostname = true
  }
}
```

```json
{
  "addresses": {
    "https": "0.0.0.0"
  },
  "ports": {
    "https": 8501
  },
  "tls": {
    "defaults": {
      "ca_file": "consul-agent-ca.pem",
      "cert_file": "dc1-server-consul-0.pem",
      "key_file": "dc1-server-consul-0-key.pem",
      "verify_incoming": true,
      "verify_outgoing": true,
      "verify_server_hostname": true
    }
  }
}
```

</CodeTabs>

</Tab>

</Tabs>

Consul will not enable TLS for the HTTP unless the `https` port has been assigned a port number `> 0`. We recommend using `8501` for `https` as this default will automatically work with some tooling.

## Start Consul servers

Now that you have configured your servers, you can start the Consul process.

```shell-session
$ systemctl start consul
```

Your servers will only be communicating with TLS encryption for RPC and consensus.

## Configure client agents

There are two methods for distributing client certificates: auto encryption and operator. We recommend the auto-encryption method to alleviate the client certificate generation and distribution step for operators. This method uses the Connect CA to generate client certificates, which are automatically distributed to all Consul clients.

Use the operator method if you need to use a third-party CA or need more fine-grained control over certificate management. 

<Tabs>
<Tab heading="Auto-encryption method" group="auto">

To configure the Consul client agents when using auto-encryption you only need to distribute the CA certificate that will be used to validate the certificates exposed by other Consul agents.

<CodeTabs>

```hcl
addresses = {
  https = "0.0.0.0"
}
ports {
  https = 8501
}
tls {
  defaults {
    ca_file = "consul-agent-ca.pem"
    verify_incoming = true
    verify_outgoing = true
    verify_server_hostname = true
  }
}
auto_encrypt = {
  tls = true
}
```

```json
{
  "addresses": {
    "https": "0.0.0.0"
  },
  "ports": {
    "https": 8501
  },
  "tls": {
    "defaults": {
      "ca_file": "consul-agent-ca.pem",
      "verify_incoming": true,
      "verify_outgoing": true,
      "verify_server_hostname": true
    }
  },
  "auto_encrypt" : {
    "tls" : true
  }
}
```

</CodeTabs>

</Tab>

</Tabs>

</Tab>
<Tab heading="Operator method" group="manual">

### Generate client certificates

On the node where you created the CA and server certificates, generate a client certificate with `consul tls cert create -client` command.

```shell-session
$ consul tls cert create -client -dc=dc1 -domain=consul
==> Using consul-agent-ca.pem and consul-agent-ca-key.pem
==> Saved dc1-client-consul-0.pem
==> Saved dc1-client-consul-0-key.pem
```

The client certificate is also signed by the same CA used for the server certificates, but it does not have the `server.<domain>.<datacenter>` in the `Common Name` and in the `Subject Alternative Name`. This means that if `verify_server_hostname` is enabled, a compromised client cannot use the certificate to start as a server and try access the datacenter data.

Now that you have created the client certificates, distribute them to every Consul client in the Consul datacenter. To complete the configuration you also need the CA certificate that will be used to validate the certificates exposed by other Consul agents.

<CodeTabs>

```hcl
addresses = {
  https = "0.0.0.0"
}
ports {
  https = 8501
}
tls {
  defaults {
    ca_file = "consul-agent-ca.pem"
    cert_file = "dc1-client-consul-0.pem"
    key_file = "dc1-client-consul-0-key.pem"
    verify_incoming = true
    verify_outgoing = true
    verify_server_hostname = true
  }
}
```

```json
{
  "addresses": {
    "https": "0.0.0.0"
  },
  "ports": {
    "https": 8501
  },
  "tls": {
    "defaults": {
      "ca_file": "consul-agent-ca.pem",
      "cert_file": "dc1-client-consul-0.pem",
      "key_file": "dc1-client-consul-0-key.pem",
      "verify_incoming": true,
      "verify_outgoing": true,
      "verify_server_hostname": true
    }
  }
}
```

</CodeTabs>

</Tab>

</Tabs>


## Start Consul clients

Now that you have configured your clients nodes, you can start the Consul process.

```shell-session
$ systemctl start consul
```

Your client agents' communications will now be encrypted using mutual TLS encryption.

## Rotate TLS certificates for Consul server agents


## Examples


## Next steps

After completing the steps in this topic, your agents will be configured with TLS for encrypted communication. With the auto encryption method, your
client certificates are managed by the server. With the operator method, you distributed all the certificates, but have a more flexible configuration.

Documentation for the commands used in this topic is available at [Consul agent configuration - TLS configuration reference](/consul/docs/agent/config/config-files#tls-configuration-reference) documentation and at the [`consul tls` CLI command reference](/consul/commands/tls). 

The other prerequisites for a secure Consul deployment are [gossip encryption](/consul/docs/security/encryption/gossip) and [Access Control Lists (ACLs)](/consul/docs/security/acl) with default deny policy.


