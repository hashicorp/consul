---
layout: docs
page_title: TrafficPermissions resource configuration reference
description: The TrafficPermissions CRD defines rules for allowing and denying traffic between services within the service mesh. Learn how to configure traffic permissions for the v2 catalog to authorize service-to-service communication in a network with zero-trust security.
---

# TrafficPermissions configuration reference

This page provides reference information for the TrafficPermissions resource, which authorizes east-west traffic between services within the service mesh. The traffic permissions CRD replaces the service intentions CRD when using the v2 catalog API. Refer to [changes to Consul's existing architecture](/consul/docs/architecture/catalog/v2#changes-to-consul-s-existing-architecture) for more information.

This custom resource definition (CRD) describes a resource related to the [Kubernetes GAMMA initiative](https://gateway-api.sigs.k8s.io/concepts/gamma/) that requires the [v2 catalog API](/consul/docs/architecture/catalog/v2). It is not compatible with the [v1 catalog API](/consul/docs/architecture/catalog/v1). For more information about GAMMA resources, refer to the [Kubernetes Gateway API documentation](https://gateway-api.sigs.k8s.io/concepts/gamma/).

## Configuration model

The following list outlines field hierarchy, language-specific data types, and requirements in a TrafficPermissions CRD. Click on a property name to view additional details, including default values.

<Tabs>

<Tab heading="YAML" group="yaml">

- [`apiVersion`](#apiversion): string | required | must be set to `auth.consul.hashicorp.com/v2beta1`
- [`kind`](#kind): string | required | must be set to `TrafficPermissions`
- [`metadata`](#metadata): map | required
  - [`name`](#metadata-name): string | required
  - [`namespace`](#metadata-namespace): string | optional <EnterpriseAlert inline />
- [`spec`](#spec): map | required
  - [`destination`](#spec-destination): map
    - [`identityName`](#spec-destination-identityname): string
  - [`action`](#spec-action): string
  - [`permissions`](#spec-permissions): list of maps
    - [`sources`](#spec-permissions-sources): map
      - [`identityName`](#spec-permissions-sources-identityname): string
      - [`namespace`](#spec-permissions-sources-namespace): string
      - [`partition`](#spec-permissions-sources-partition): string
      - [`peer`](#spec-permissions-sources-peer): string
      - [`samenessGroup`](#spec-permissions-sources-samenessgroup): string
      - [`exclude`](#spec-permissions-sources-exclude): map
        - [`identityName`](#spec-permissions-sources-exclude): string
        - [`namespace`](#spec-permissions-sources-exclude): string
        - [`partition`](#spec-permissions-sources-exclude): string
        - [`peer`](#spec-permissions-sources-exclude): string
        - [`samenessGroup`](#spec-permissions-sources-exclude): string
    - [`destinationRules`](#spec-permissions-destinationrules):
<!--
      - [`header`](#spec-permissions-destinationrules-header): map
        - [`name`](#spec-permissions-destinationrules-header): string
        - [`present`](#spec-permissions-destinationrules-header): boolean | `false`
        - [`exact`](#spec-permissions-destinationrules-header): string
        - [`prefix`](#spec-permissions-destinationrules-header): string
        - [`suffix`](#spec-permissions-destinationrules-header): string
        - [`regex`](#spec-permissions-destinationrules-header): string
        - [`invert`](#spec-permissions-destinationrules-header): boolean | `false`
      - [`methods`](#spec-permissions-destinationrules-methods): array of strings
      - [`pathExact`](#spec-permissions-destinationrules-pathexact): string
      - [`pathPrefix`](#spec-permissions-destinationrules-pathprefix): string
      - [`pathRegex`](#spec-permissions-destinationrules-pathregex): string
-->
      - [`portNames`](#spec-permissions-destinationrules-portNames): array of strings
<!--
      - [`exclude`](#spec-permissions-destinationrules-exclude): map
        - [`header`](#spec-permissions-destinationrules-exclude-header): map
          - [`exact`](#spec-permissions-destinationrules-exclude-header): string
          - [`invert`](#spec-permissions-destinationrules-exclude-header): boolean | `false`
          - [`name`](#spec-permissions-destinationrules-exclude-header): string
          - [`prefix`](#spec-permissions-destinationrules-exclude-header): string
          - [`present`](#spec-permissions-destinationrules-exclude-header): boolean | `false`
          - [`regex`](#spec-permissions-destinationrules-exclude-header): string
          - [`suffix`](#spec-permissions-destinationrules-exclude-header): string
        - [`methods`](#spec-permissions-destinationrules-exclude-methods): array of strings
        - [`pathExact`](#spec-permissions-destinationrules-exclude-pathexact): string
        - [`pathPrefix`](#spec-permissions-destinationrules-exclude-pathprefix): string
        - [`pathRegex`](#spec-permissions-destinationrules-exclude-pathregex): string
        - [`portNames`](#spec-permissions-destinationrules-exclude-portNames): array of strings
  -->

</Tab>
</Tabs>

## Complete configuration

When every field is defined, a `TrafficPermissions` CRD has the following form:

```yaml
apiVersion: auth.consul.hashicorp.com/v2beta1    # required
kind: TrafficPermissions                         # required
metadata:
  name: <permissionsResourceName>
  namespace: <default>
spec:
  destination:
    identityName: <permissionsDestinationService>
  action: allow
  permissions:
    - sources:
      identityName: <sourceWorkloadIdentity> 
      namespace: <sourceNamespace>
      partition: <sourceAdminPartition>
      peer: <sourceClusterPeer>
      samenessGroup: <sourceSamenessGroup>
      exclude:
        identityName: <workloadIdentityExcludedFromPermission>
        namespace: <namespaceExcludedFromPermission>
        partition: <adminPartitionExcludedFromPermission>
        peer: <clusterPeerExcludedFromPermission>
        samenessGroup: <samenessGroupExcludedFromPermission>
    destinationRules:
      portNames: 
        - <servicePortName>
```

## Specification

This section provides details about the fields you can configure in the `TrafficPermissions` custom resource definition (CRD).

### `apiVersion`

Specifies the version of the Consul API for integrating with Kubernetes. The value must be `auth.consul.hashicorp.com/v2beta1`.

#### Values

- Default: None
- This field is required.
- String value that must be set to `auth.consul.hashicorp.com/v2beta1`.

### `kind`

Specifies the type of CRD to implement. Must be set to `TrafficPermissions`.

#### Values

- Default: None
- This field is required.
- Data type: String value that must be set to `TrafficPermissions`.

### `metadata`

Map that contains an arbitrary name for the CRD and the namespace it applies to.

#### Values

- Default: None
- Data type: Map

### `metadata.name`

Specifies a name for the CRD. The name is metadata that you can use to reference the resource when performing Consul operations, such as using the `consul resource` command. Refer to [`consul resource`](/consul/docs/k8s/connect/multiport/reference/resource-command) for more information.

#### Values

- Default: None
- This field is required.
- Data type: String

### `metadata.namespace` <EnterpriseAlert inline />

Specifies the namespace that the service resolver applies to. Refer to [namespaces](/consul/docs/enterprise/namespaces) for more information.

#### Values

- Default: None
- Data type: String

### `spec`

Map that contains the details about the `TrafficPermissions` CRD. The `apiVersion`, `kind`, and `metadata` fields are siblings of the spec field. All other configurations are children.

#### Values

- Default: None
- This field is required.
- Data type: Map

### `spec.destination`

Specifies the proxies of the services where these traffic permissions apply.

#### Values

- Default: None
- Data type: Map

### `spec.destination.identityName`

Specifies the Workload identity for a service. The permissions you configure in this `TrafficPermissions` CRD apply to sidecar proxies when a request has this identity as their destination.

#### Values

- Default: None
- Data type: String

### `spec.action`

Specifies whether the proxy should _allow traffic_ or _deny traffic_ between the destination in [`spec.destination`](#spec-destination) and the sources in [`spec.permissions.sources`](#spec-permissions-sources).

By default, Consul allows traffic between all services. When the Helm value `global.acls.manageSystemACLs` is set to `true`, then Consul operates in "default-deny" mode. In this mode, `TrafficPermissions` CRDs that allow traffic between services are required for service-to-service traffic.
<!--
The `ACTION_UNKNOWN` value is a reserved value that enables compatibility with future configurations. Do not specify this value in the current release.
-->

#### Values

- Default: None
- Data type: String that must contain one of the following values:

  - `ACTION_ALLOW`
  - `ACTION_DENY`
<!--
  - `ACTION_UNKNOWN`
-->

### `spec.permissions`

Permissions is a list of the traffic permissions Consul evaluates requests against. When the list contains more than one permission, Consul follows OR semantics to select the permission.

#### Values

- Default: None
- Data type: List of maps

### `spec.permissions.sources`

Lists sources for traffic in the permission. This block contains information Consul uses to evaluate the service that originated the request when the sidecar proxy authorizes incoming traffic.

To specify wildcard references in this block using `*`, omit all other fields. For example, you can apply traffic permissions to all namespaces using the wildcard, but you cannot specify an identity name, partition, peer, or sameness group in the same source.

#### Values

- Default: None
- Data type: Map

### `spec.permissions.sources.identityName`

Specifies the Workload identity for the service that originates the request.

#### Values

- Default: None
- Data type: Map

### `spec.permissions.sources.namespace`

Specifies the Consul namespace for the service that originates the request.

#### Values

- Default: None
- Data type: Map

### `spec.permissions.sources.partition`

Specifies the Consul admin partition for the service that originates the request.

#### Values

- Default: None
- Data type: Map

### `spec.permissions.sources.peer`

Specifies the Consul cluster peer where the service that originates the request is scheduled.

#### Values

- Default: None
- Data type: Map

### `spec.permissions.sources.samenessGroup`

Specifies the sameness group that includes the service that originates the request.

#### Values

- Default: None
- Data type: Map

### `spec.permissions.sources.exclude`

Specifies sources to exclude from the defined source.

#### Values

- Default: None
- Data type: Array of maps

### `spec.permissions.destinationRules`

Specifies L7 properties to match against when Consul enforces traffic permissions.

When [`spec.action`](#spec-action) _allows traffic_, Consul authorizes requests to the destination service when the request matches one or more rules defined in this block. Requests that do not match any rules are denied.

When [`spec.action`](#spec-action) _denies traffic_, Consul denies authorization to requests that match one or more rules defined in this block. Requests that do not match any rules are allowed.

#### Values

- Default: None
- Data type: Map
<!--
### `spec.permissions.destinationRules.header`

Specifies a set of criteria for matching HTTP request headers. The request header must match all specified criteria for the permission to apply.

#### Values

- Default: None
- Data type: List of maps

Each member of the header list is a map that contains a name field and at least one match criterion. The following table describes the parameters that each member of the header list may contain:

| Parameter | Description | Data type | Required |
| --- | --- | --- | --- |
| `name` | Specifies the name of the header to match. | string | required |
| `present` | Enables a match if the header configured in the `name` field appears in the request. Consul matches on any value as long as the header key appears in the request. Do not specify `present` if `exact`, `prefix`, `suffix`, or `regex` are configured in the same `header` configuration. | boolean | optional |
| `exact` | Specifies a value for the header key set in the `name` field. If the request header value matches the `exact` value, Consul applies the permission.  Do not specify `exact` if `present`, `prefix`, `suffix`, or `regex` are configured in the same `header` configuration. | string | optional |
| `prefix` | Specifies a prefix value for the header key set in the `name` field. If the request header value starts with the `prefix` value, Consul applies the permission.  Do not specify `prefix` if `present`, `exact`, `suffix`, or `regex` are configured in the same `header` configuration. | string | optional |
| `suffix` | Specifies a suffix value for the header key set in the `name` field. If the request header value ends with the `suffix` value, Consul applies the permission.  Do not specify `suffix` if `present`, `exact`, `prefix`, or `regex` are configured in the same `header` configuration. | string | optional |
| `regex` | Specifies a regular expression pattern as the value for the header key set in the `name` field. If the request header value matches the regex, Consul applies the permission. Do not specify `regex` if `present`, `exact`, `prefix`, or `suffix` are configured in the same `header` configuration. The regex syntax is proxy-specific. If using Envoy, refer to the [re2 documentation](https://github.com/google/re2/wiki/Syntax) for details. | string | optional |
| `invert` | Inverts the matching logic configured in the `header`. Default is `false`. | boolean | optional |

### `spec.permissions.destinationRules.methods`

Specifies a list of HTTP methods. Consul applies the permission if the source sent the request using one of the specified methods. Refer to the [Mozilla documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods) for details on supported request methods.

#### Values

- Default: None
- Data type: List of strings with one or more of the following values:

  - `GET`
  - `HEAD`
  - `POST`
  - `PUT`
  - `DELETE`
  - `CONNECT`
  - `OPTIONS`
  - `TRACE`
  - `PATCH`

Refer to the [Mozilla documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods) for more information about each method.

### `spec.permissions.destinationRules.pathExact`

Specifies an exact path to match on the request path. Do not specify `pathExact` if `pathPrefix` or `pathRegex` are configured in the same destination rule.

#### Values

- Default: None
- Data type: String

### `spec.permissions.destinationRules.pathPrefix`

Specifies a path prefix to match on the request path. Do not specify `pathPrefix` if `pathExact` or `pathRegex` are configured in the same destination rule.

#### Values

- Default: None
- Data type: String

### `spec.permissions.destinationRules.pathRegex`

Defines a regular expression to match on the request path. Do not specify `pathRegex` if `pathExact` or `pathPrefix` are configured in the same destination rule. The regex syntax is proxy-specific. If using Envoy, refer to the [re2 documentation](https://github.com/google/re2/wiki/Syntax) for details.

#### Values

- Default: None
- Data type: String
-->

### `spec.permissions.destinationRules.portNames`

Specifies a port name that the Kubernetes Service exposes at the destination.

#### Values

- Default: None
- Data type: String
<!--
### `spec.permissions.destinationRules.exclude`

Specifies a list of destination rules to exclude when evaluating an incoming connection.

#### Values

- Default: None
- Data type: List of maps

### `spec.permissions.destinationRules.exclude.header`

Specifies a set of header information that qualify for an exclusion to the destination rules. When an incoming request contains matching header information, the request will not produce a match when evaluating the destination rule that is otherwise defined.

When [`spec.action`](#spec-action) _allows traffic_, Consul denies permission to the exclusion.

When [`spec.action`](#spec-action) _denies traffic_, Consul allows permission to the exclusion.

The request header must match all specified criteria to be considered an exclusion.

#### Values

- Default: None
- Data type: List of maps

Each member of the header list is a map that contains a name field and at least one match criterion. The following table describes the parameters that each member of the header list may contain:

| Parameter | Description | Data type | Required |
| --- | --- | --- | --- |
| `name` | Specifies the name of the header to match. | string | required |
| `present` | Enables a match if the header configured in the `name` field appears in the request. Consul matches on any value as long as the header key appears in the request. Do not specify `present` if `exact`, `prefix`, `suffix`, or `regex` are configured in the same `exclude.header` configuration. | boolean | optional |
| `exact` | Specifies a value for the header key set in the `name` field. If the request header value matches the `exact` value, Consul applies the permission.  Do not specify `exact` if `present`, `prefix`, `suffix`, or `regex` are configured in the same `exclude.header` configuration. | string | optional |
| `prefix` | Specifies a prefix value for the header key set in the `name` field. If the request header value starts with the `prefix` value, Consul applies the permission.  Do not specify `prefix` if `present`, `exact`, `suffix`, or `regex` are configured in the same `exclude.header` configuration. | string | optional |
| `suffix` | Specifies a suffix value for the header key set in the `name` field. If the request header value ends with the `suffix` value, Consul applies the permission.  Do not specify `suffix` if `present`, `exact`, `prefix`, or `regex` are configured in the same `exclude.header` configuration. | string | optional |
| `regex` | Specifies a regular expression pattern as the value for the header key set in the `name` field. If the request header value matches the regex, Consul applies the permission. Do not specify `regex` if `present`, `exact`, `prefix`, or `suffix` are configured in the same `exclude.header` configuration. The regex syntax is proxy-specific. If using Envoy, refer to the [re2 documentation](https://github.com/google/re2/wiki/Syntax) for details. | string | optional |
| `invert` | Inverts the matching logic configured in the `exclude.header`. Default is `false`. | boolean | optional |

### `spec.permissions.destinationRules.exclude.methods`

Specifies a set of HTTP methods that qualify a request for an exclusion to the destination rules. When an incoming request uses one of the specified methods, the request will not produce a match when evaluating the destination rule that is otherwise defined.

Refer to the [Mozilla documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods) for details on supported request methods.

#### Values

- Default: None
- Data type: List of strings with one or more of the following values:

  - `GET`
  - `HEAD`
  - `POST`
  - `PUT`
  - `DELETE`
  - `CONNECT`
  - `OPTIONS`
  - `TRACE`
  - `PATCH`

Refer to the [Mozilla documentation](https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods) for more information about each method.

### `spec.permissions.destinationRules.exclude.pathExact`

Specifies an exact path that causes a request to be considered an exclusion to the destination rules.

#### Values

- Default: None
- Data type: String

### `spec.permissions.destinationRules.exclude.pathPrefix`

Specifies a path prefix that causes a request to be considered an exclusion to the destination rules.

#### Values

- Default: None
- Data type: String

### `spec.permissions.destinationRules.exclude.pathRegex`

Defines a regular expression that causes a request to be considered an exclusion to the destination rules when it matches a request path. The regex syntax is proxy-specific. If using Envoy, refer to the [re2 documentation](https://github.com/google/re2/wiki/Syntax) for details.

#### Values

- Default: None
- Data type: String

### `spec.permissions.destinationRules.exclude.portNames`

Specifies a port name that exposes a Kubernetes Service. An incoming requests addressed to the port is considered an exclusion to the destination rules.

#### Values

- Default: None
- Data type: List of strings
-->

## Examples

The following examples demonstrate common `TrafficPermissions`` CRD configuration patterns for specific use cases.

### Deny traffic between services

The following example configures traffic permissions to deny traffic when the `web` service makes a request to the `api` service on the `admin` port.

```yaml
apiVersion: auth.consul.hashicorp.com/v2beta1
kind: TrafficPermissions
metadata:
  name: web-to-api-port-deny
spec:
  destination:
    identityName: api
  action: deny
  permissions:
    - sources:
        - identityName: web
      destinationRules:
        - portNames: ["admin"]
```
