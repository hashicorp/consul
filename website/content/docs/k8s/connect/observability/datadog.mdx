---
layout: docs
page_title: Configure Datadog Metrics Collection for Consul on Kubernetes
description: >-
  Enable Consul Monitoring via Datadog using the `metrics.datadog` helm value override options.
---

# Datadog Integration for Consul on Kubernetes

The Helm chart includes automated configuration options in order to integrate with Datadog.

## Datadog Metrics Integration Methods

- DogstatsD
- Datadog Checks: Official Consul Integration
- Openmetrics Prometheus

<Highlight>
  Choose <strong><em>one</em></strong> integration method from the three described below that best suites the intent for metrics collection. <strong><a href="https://docs.datadoghq.com/developers/dogstatsd/?tab=kubernetes">DogStatsD</a></strong>, <strong><a href="https://docs.datadoghq.com/integrations/consul/?tab=containerized">Consul Integration</a></strong>, and <strong><a href="https://docs.datadoghq.com/containers/kubernetes/prometheus/?tab=kubernetesadv2">Openmetrics Prometheus</a></strong> methods of integration are <strong><em>mutually exclusive</em></strong>.
  <br/><br/>
  <strong>Reasoning:</strong> <em>The consul-k8s helm chart automated configuration implements Datadog's <a href="https://docs.datadoghq.com/integrations/consul/?tab=containerized">Consul Integration</a> method using the <a href="https://github.com/DataDog/integrations-core/blob/07c04c5e9465ba1f3e0198830896d05923e81283/consul/datadog_checks/consul/data/conf.yaml.example#L59"><code>use_prometheus_endpoint</code></a> configuration parameter. <strong>DogstatsD</strong>, <strong>Consul Integration</strong>, and <strong>Openmetrics Prometheus</strong> Metrics <strong><em>by design</em></strong> share the same <a href="https://docs.datadoghq.com/integrations/consul/?tab=host#data-collected">metric name</a> syntax for collection, and would therefore cause a conflict.
    The <a href="https://github.com/DataDog/integrations-core/blob/07c04c5e9465ba1f3e0198830896d05923e81283/consul/datadog_checks/consul/consul.py#L55-L61">consul.py</a> integration source code, as well as the <a href="https://github.com/hashicorp/consul-k8s/blob/4cac70496788f50354f96e9331003fcf338f419c/charts/consul/templates/_helpers.tpl#L595-L598">consul-k8s helm chart</a> prohibit the enablement of more that one integration at a time.</em>
</Highlight>

### DogstatsD: Consul Server Agent Metrics Collection

<Tabs>
  <CodeBlockConfig heading={"DogstatsD (UDS)"}>

  ```yaml
  metrics:
    enabled: true
    enableAgentMetrics: true
    datadog:
      enabled: true
      namespace: "datadog"
      dogstatsd:
        enabled: true
        socketTransportType: "UDS"
        dogstatsdAddr: "/var/run/datadog/dsd.socket"
  ```

  </CodeBlockConfig>

  <CodeBlockConfig heading={"DogstatsD (UDP - KubeDNS)"}>

  ```yaml
  metrics:
    enabled: true
    enableAgentMetrics: true
    datadog:
      enabled: true
      namespace: "datadog"
      dogstatsd:
        enabled: true
        socketTransportType: "UDP"
        # Set `dogstatsdPort` to `0` (default) to omit port number append to address.
        dogstatsdPort: 0
        dogstatsdAddr: "datadog.datadog.svc.cluster.local"
  ```

  </CodeBlockConfig>

  <CodeBlockConfig heading={"DogstatsD (UDP - IP:Port)"}>

  ```yaml
  metrics:
    enabled: true
    enableAgentMetrics: true
    datadog:
      enabled: true
      namespace: "datadog"
      dogstatsd:
        enabled: true
        socketTransportType: "UDP"
        dogstatsdPort: 8125
        dogstatsdAddr: "172.20.180.10"
  ```

  </CodeBlockConfig>
</Tabs>

#### Metrics Data Collected

  - Collects DogstatsD formatted metrics pertaining to Consul Serf Membership, Raft, DNS Performance, Agent Telemetry, and much more.
  - Enables configuring DogstatsD metric collection using one of either `UDP` or `Unix Domain Socket configuration`

### Datadog Checks: (Official Consul Integration)

  <CodeBlockConfig heading={"Datadog Consul Checks"}>

  ```yaml
  metrics:
    enabled: true
    enableAgentMetrics: true
    datadog:
      enabled: true
      namespace: "datadog"
  ```

  </CodeBlockConfig>

  | Consul Component | Description                                         | API Endpoint(s)                                                      |
  |------------------|-----------------------------------------------------|----------------------------------------------------------------------|
  | Agent            | Agent Metadata (i.e., version)                      | `/v1/agent/self`                                                     |
  | Metrics          | Prometheus formatted metrics                        | `/v1/agent/metrics`                                                  |
  | Serf             | Events and Membership Flaps                         | `/v1/health/service/consul` `/v1/agent/self`                         |
  | Raft             | Monitors Raft peer information and leader elections | `/v1/status/leader` `/v1/status/peers`                               |
  | Catalog Services | Service Health Status and Node Count                | `/v1/catalog/services` `/v1/health/state/any`                        |
  | Catalog Nodes    | Node Service Count and Health Status                | `/v1/health/state/any` `/v1/health/service/<service>`                |
  | Consul Latency   | Consul LAN + WAN Coordinate Latency Calculations    | `/v1/agent/self` `/v1/coordinate/nodes` `/v1/coordinate/datacenters` |


#### Metrics Data Collected

The list of Consul's Prometheus metrics scraped and mapped by this method are listed in the latest [metrics.py](https://github.com/DataDog/integrations-core/blob/master/consul/datadog_checks/consul/metrics.py) of the integration source code.

Review the [Datadog Documentation](https://docs.datadoghq.com/integrations/consul/?tab=containerized#data-collected) for the full description of Metrics data collected.

### Openmetrics Prometheus: Consul Server Agent Metrics Collection (Advanced)

  <CodeBlockConfig heading={"OpenMetrics Prometheus"}>

  ```yaml
  metrics:
    enabled: true
    enableAgentMetrics: true
    datadog:
      enabled: true
      namespace: "datadog"
      openMetricsPrometheus:
        enabled: true
  ```

  </CodeBlockConfig>

This method of integration is useful for cases where Prometheus enabled scrapes are desired, and further customization of the collected data is desired.

By default, all metrics pulled using this method will scrape Consul metrics using the `/v1/agent/metrics?format=prometheus` API query, and are considered to be **_custom metrics_**.

Use of this method will map to Datadog as described in [Mapping Prometheus Metrics to Datadog Metrics](https://docs.datadoghq.com/integrations/guide/prometheus-metrics/?tab=latestversion).

| OpenMetrics Metric Type | Datadog Metric Type                |
|-------------------------|------------------------------------|
| `Gauge`                 | `gauge`                            |
| `Counter`               | `count`                            |
| Histogram: `_count `    | `count.count`                      |
| Histogram: `_sum`       | `count.sum`                        |
| Histogram: `_bucket`    | `count.bucket` \|\| `distribution` |
| Summary: `_count`       | `count.count`                      |
| Summary: `_sum`         | `count.sum`                        |
| Summary: `sample`       | `gauge.quantile`                   |

#### Metrics Data Collected

  - Collects Consul related metrics via the `/v1/agent/metrics` API endpoint leveraging the `prometheus` query parameter.
  - Default configuration, uses wildcard `".*"` to collect all metrics emitted from the endpoint.
