---
layout: docs
page_title: Configure Datadog Metrics Collection for Consul on Kubernetes
description: >-
  Enable Consul Monitoring via Datadog using the `metrics.datadog` helm value override options.
---

# Datadog Integration for Consul on Kubernetes

The Helm chart includes automated configuration options in order to integrate with Datadog.

## Datadog Metrics Integration Methods

- [DogstatsD](#dogstatsd)
- [Datadog Checks: Official Consul Integration](#datadog-checks-official-consul-integration)
- [Openmetrics Prometheus](#openmetrics-prometheus)

<Highlight>
  Users should choose <strong><em>one</em></strong> integration method from the three described below that best suites the intent for metrics collection. <strong><a href="https://docs.datadoghq.com/developers/dogstatsd/?tab=kubernetes">DogStatsD</a></strong>, <strong><a href="https://docs.datadoghq.com/integrations/consul/?tab=containerized">Consul Integration</a></strong>, and <strong><a href="https://docs.datadoghq.com/containers/kubernetes/prometheus/?tab=kubernetesadv2">Openmetrics Prometheus</a></strong> methods of integration are <strong><em>mutually exclusive</em></strong>.
  <br/><br/>
  <strong>Reasoning:</strong> <em>The consul-k8s helm chart automated configuration implements Datadog's <a href="https://docs.datadoghq.com/integrations/consul/?tab=containerized">Consul Integration</a> method using the <a href="https://github.com/DataDog/integrations-core/blob/07c04c5e9465ba1f3e0198830896d05923e81283/consul/datadog_checks/consul/data/conf.yaml.example#L59"><code>use_prometheus_endpoint</code></a> configuration parameter. <strong>DogstatsD</strong>, <strong>Consul Integration</strong>, and <strong>Openmetrics Prometheus</strong> Metrics <strong><em>by design</em></strong> share the same <a href="https://docs.datadoghq.com/integrations/consul/?tab=host#data-collected">metric name</a> syntax for collection, and would therefore cause a conflict.
    The <a href="https://github.com/DataDog/integrations-core/blob/07c04c5e9465ba1f3e0198830896d05923e81283/consul/datadog_checks/consul/consul.py#L55-L61">consul.py</a> integration source code, as well as the <a href="https://github.com/hashicorp/consul-k8s/blob/4cac70496788f50354f96e9331003fcf338f419c/charts/consul/templates/_helpers.tpl#L595-L598">consul-k8s helm chart</a> prohibit the enablement of more that one integration at a time.</em>
</Highlight>

## DogstatsD

This method of implementation leverages the [hashicorp/go-metrics DogstatsD client library](https://github.com/hashicorp/go-metrics/tree/master/datadog) to manage metrics collection.
Metrics are aggregated and sent via UDP or UDS transports to a Datadog Agent that runs on the same Kube Node as the Consul servers.

Enabling this method of metrics collection allows Consul to control the delivery of metrics traffic directly to a Datadog agent rather
than a Datadog agent attempting to reach Consul and scrape the `/v1/agent/metrics` API endpoint.

This is accomplished by updating each server agent's configuration telemetry stanza.

### Helm Chart Configuration

<Tabs>
  <CodeBlockConfig heading={"DogstatsD (UDS)"}>

  Consul Helm Chart Overrides

  ```yaml
  metrics:
    enabled: true
    enableAgentMetrics: true
    datadog:
      enabled: true
      namespace: "datadog"
      dogstatsd:
        enabled: true
        socketTransportType: "UDS"
        dogstatsdAddr: "/var/run/datadog/dsd.socket"
  ```

  Resulting server agent telemetry configuration

  ```json
  {
    "telemetry": {
      "dogstatsd_addr": "unix:///var/run/datadog/dsd.socket"
    }
  }
  ```

  </CodeBlockConfig>

  <CodeBlockConfig heading={"DogstatsD (UDP:KubeService)"}>

  Consul Helm Chart Overrides

  ```yaml
  metrics:
    enabled: true
    enableAgentMetrics: true
    datadog:
      enabled: true
      namespace: "datadog"
      dogstatsd:
        enabled: true
        socketTransportType: "UDP"
        dogstatsdPort: 0          # Set `dogstatsdPort` to `0` (default) to omit port number append to address.
        dogstatsdAddr: "datadog-agent.datadog.svc.cluster.local"
  ```

  Resulting server agent telemetry configuration

  ```json
  {
    "telemetry": {
      "dogstatsd_addr": "datadog-agent.datadog.svc.cluster.local"
    }
  }
  ```

  </CodeBlockConfig>

  <CodeBlockConfig heading={"DogstatsD (UDP: hostPort)"}>

  Consul Helm Chart Overrides

  ```yaml
  metrics:
    enabled: true
    enableAgentMetrics: true
    datadog:
      enabled: true
      namespace: "datadog"
      dogstatsd:
        enabled: true
        socketTransportType: "UDP"
        dogstatsdPort: 8125
        dogstatsdAddr: "172.20.180.10"
  ```

  Resulting server agent telemetry configuration

  ```json
  {
    "telemetry": {
      "dogstatsd_addr": "172.20.180.10:8125",
    }
  }
  ```

  </CodeBlockConfig>
</Tabs>

This integration method accomplishes metrics collection by leveraging either [Unix Domain Sockets](https://docs.datadoghq.com/developers/dogstatsd/unix_socket/?tab=kubernetes) (**UDS**) or [User Datagram Protocol](https://docs.datadoghq.com/developers/dogstatsd/?tab=kubernetes#agent) (**UDP**) transport.
Practitioners who manage their Kubernetes infrastructure and/or service-mesh should take into account the implications outlined in the table below.

### UDS/UDP Advantages and Disadvantages

<Tabs>
  <Tab heading={"UDS"}>
    <table>
      <thead>
      <tr>
        <th>Advantages</th>
        <th>Disadvantages</th>
        <th>Packet Delivery</th>
      </tr>
      </thead>
      <tbody>
      <tr>
        <td>No IP or DNS resolution requirement for Datadog Agent<br/><br/>Improved network performance<br/><br/>Higher throughput capacity<br/><br/>Packet error handling<br/><br/>Automatic container ID tagging</td>
        <td>Requires <a href="https://kubernetes.io/docs/concepts/storage/volumes/#hostpath">hostPath</a> Volume attachment<br/><br/>Datadog Agent must run on every host you send metrics from</td>
        <td>Unix Domain Socket File</td>
      </tr>
      </tbody>
    </table>
  </Tab>
  <Tab heading={"UDP"}>
    <table>
      <thead>
      <tr>
        <th>Advantages</th>
        <th>Disadvantages</th>
        <th>Packet Delivery</th>
      </tr>
      </thead>
      <tbody>
      <tr>
        <td>Does <strong>not</strong> require <a href="https://kubernetes.io/docs/concepts/storage/volumes/#hostpath">hostPath</a> Volume attachment<br/><br/>(<strong><em>KubeDNS</em></strong>) Does <strong>not</strong> require Hostport exposure if accessible from cluster<br/><br/>Similar <code>IP:Port</code> configuration as Virtual Machine hosts</td>
        <td><strong>No</strong> packet error handling<br/><br/>(<strong><em>Hostport</em></strong>) Requires a networking provider that adheres to the CNI specification, such as Calico, Canal, or Flannel.<br/><br/>(<strong><em>Hostport</em></strong>) Requires port to be exposed on host using <code>hostNetwork</code><br/><br/>(<strong><em>Hostport</em></strong>) Requires firewall access controls to permit access<br/><br/>(<strong><em>Hostport</em></strong>) Network Namespace sharing is required</td>
        <td>Kubernetes Service <code>IP:Port</code><br/><br/> <strong>or</strong> <br/><br/>Container host port</td>
      </tr>
      </tbody>
    </table>
  </Tab>
</Tabs>

#### Verifying DogstatsD Metric Collection

To confirm you're Datadog agent is receiving traffic, the `status` subcommand can be ran from the Datadog Agent expecting to receive DogstatsD traffic from Consul.

There should be an increase in either UDP or UDS traffic packet counts from the resultant output after the configuration has been properly established.


 | Transport   | Command                                                                    | Pod           | Container | Example Output                                                                                 |
 |:------------|----------------------------------------------------------------------------|---------------|-----------|------------------------------------------------------------------------------------------------|
 | `UDP`/`UDS` | `agent status`                                                             | datadog-agent | agent     | See below.                                                                                     |
 | `UDP`       | `netstat -nup \| grep "<dd_agent_or_pod_hostIP>:8125.*ESTABLISHED"`        | consul-server | consul    | `udp        0      0 127.0.0.1:53874         127.0.0.1:8125          ESTABLISHED 23176/consul` |
 | `UDS`       | `nc -U -u -w1 /var/run/datadog/dsd.socket` _(update socket path as req'd)_ | consul-server | consul    | `Bound on /tmp/nc-IjJkoG/recv.sock`                                                            |

<Tabs>
  <CodeBlockConfig heading={"UDP"}>

  ```shell
  # Example: UDP Packet and Metric Packet Traffic Increase
  =========
  DogStatsD
  =========
    Event Packets: 0
    Event Parse Errors: 0
    Metric Packets: 5,908
    Metric Parse Errors: 0
    Service Check Packets: 0
    Service Check Parse Errors: 0
    Udp Bytes: 636,872
    Udp Packet Reading Errors: 0
    Udp Packets: 3,300
    Uds Bytes: 0
    Uds Origin Detection Errors: 0
    Uds Packet Reading Errors: 0
    Uds Packets: 0
    Unterminated Metric Errors: 0
  ```
  </CodeBlockConfig>
  <CodeBlockConfig heading={"UDS"}>

  ```shell
  # Example: UDS Packet and Metric Packet Traffic Increase
  =========
  DogStatsD
  =========
    Event Packets: 0
    Event Parse Errors: 0
    Metric Packets: 30,523
    Metric Parse Errors: 0
    Service Check Packets: 0
    Service Check Parse Errors: 0
    Udp Bytes: 124,635
    Udp Packet Reading Errors: 0
    Udp Packets: 731
    Uds Bytes: 2,957,433
    Uds Origin Detection Errors: 0
    Uds Packet Reading Errors: 0
    Uds Packets: 11,563
    Unterminated Metric Errors: 0
  ```

  </CodeBlockConfig>
</Tabs>


#### Metrics Data Collected

  - Full list of metrics sent via DogstatsD consists of those listed in the [Agent Telemetry](https://developer.hashicorp.com/consul/docs/agent/telemetry) documentation.


## Datadog Checks: Official Consul Integration

The Datadog Agent package includes official third-party integrations for built-in availability upon agent deployment.

The Consul Integration Datadog checks provided some additional metric verification checks that leverage Consul's built-in feature-set, and help monitor Consul
during normal operation beyond that of Consul's available metrics.

See the below table for an outline of the features added by the official integration.

### Additional Integration Checks Performed

| Consul Component | Description                                         | API Endpoint(s)                                                      |
|------------------|-----------------------------------------------------|----------------------------------------------------------------------|
| Agent            | Agent Metadata (i.e., version)                      | `/v1/agent/self`                                                     |
| Metrics          | Prometheus formatted metrics                        | `/v1/agent/metrics`                                                  |
| Serf             | Events and Membership Flaps                         | `/v1/health/service/consul` `/v1/agent/self`                         |
| Raft             | Monitors Raft peer information and leader elections | `/v1/status/leader` `/v1/status/peers`                               |
| Catalog Services | Service Health Status and Node Count                | `/v1/catalog/services` `/v1/health/state/any`                        |
| Catalog Nodes    | Node Service Count and Health Status                | `/v1/health/state/any` `/v1/health/service/<service>`                |
| Consul Latency   | Consul LAN + WAN Coordinate Latency Calculations    | `/v1/agent/self` `/v1/coordinate/nodes` `/v1/coordinate/datacenters` |


### Helm Chart Configuration

  <CodeBlockConfig heading={"Datadog Consul Checks"}>

  ```yaml
  metrics:
    enabled: true
    enableAgentMetrics: true
    datadog:
      enabled: true
      namespace: "datadog"
  ```

  </CodeBlockConfig>




#### Metrics Data Collected

The list of Consul's Prometheus metrics scraped and mapped by this method are listed in the latest [metrics.py](https://github.com/DataDog/integrations-core/blob/master/consul/datadog_checks/consul/metrics.py) of the integration source code.

To understand how Consul Latency metrics are calculated, review the [Consul Network Coordinates](https://developer.hashicorp.com/consul/docs/architecture/coordinates) documentation.

Review the [Datadog Documentation](https://docs.datadoghq.com/integrations/consul/?tab=containerized#data-collected) for the full description of Metrics data collected.

## Openmetrics Prometheus

### Helm Chart Configuration

  <CodeBlockConfig heading={"OpenMetrics Prometheus"}>

  ```yaml
  metrics:
    enabled: true
    enableAgentMetrics: true
    datadog:
      enabled: true
      namespace: "datadog"
      openMetricsPrometheus:
        enabled: true
  ```

  </CodeBlockConfig>

This method of integration is useful for cases where Prometheus enabled scrapes are desired, and further customization of the collected data is desired.

By default, all metrics pulled using this method will scrape Consul metrics using the `/v1/agent/metrics?format=prometheus` API query, and are considered to be **_custom metrics_**.

Use of this method will map to Datadog as described in [Mapping Prometheus Metrics to Datadog Metrics](https://docs.datadoghq.com/integrations/guide/prometheus-metrics/?tab=latestversion) and summarized below.

| OpenMetrics Metric Type | Datadog Metric Type                |
|-------------------------|------------------------------------|
| `Gauge`                 | `gauge`                            |
| `Counter`               | `count`                            |
| Histogram: `_count `    | `count.count`                      |
| Histogram: `_sum`       | `count.sum`                        |
| Histogram: `_bucket`    | `count.bucket` \|\| `distribution` |
| Summary: `_count`       | `count.count`                      |
| Summary: `_sum`         | `count.sum`                        |
| Summary: `sample`       | `gauge.quantile`                   |


#### Metrics Data Collected

  - Collects Consul related metrics via the `/v1/agent/metrics` API endpoint leveraging the `prometheus` query parameter.
  - Default configuration, uses a wildcard `".*"` to collect all metrics emitted from the endpoint, therefore the list of metrics scraped consists of those listed in the [Agent Telemetry](https://developer.hashicorp.com/consul/docs/agent/telemetry) documentation.
