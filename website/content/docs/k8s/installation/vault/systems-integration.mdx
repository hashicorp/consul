---
layout: docs
page_title: Vault as Secrets Backend Systems Integration Overview
description: >-
  Overview of the systems integration aspects to using Vault as secrets backend for Consul on Kubernetes.
---

# Vault as the secrets backend - Systems Integration

## Overview
At a high level, configuring a systems integration of Vault with Consul on Kubernetes consists of the following steps:
- One time set up on Vault
  - Enabling Vault KV Secrets Engine - Version 2 to store arbitrary secrets
  - Enabling Vault PKI Engine if you are choosing to store and manage either [Consul Server TLS credentials](/docs/k8s/installation/vault/data-integration/server-tls) or [Service Mesh and Consul client TLS credentials](/docs/k8s/installation/vault/data-integration/connect-ca)
- Set up per Consul data center
  - Installing the Vault Injector within the Consul data center installation
  - Configuring a Kubernetes Auth Method in Vault to authenticate and authorize operations from the Consul data center
  - Enable Vault as the secrets backend in the Consul data center

## One time set up on Vault
### Vault KV Secrets Engine - Version 2
The following secrets can be stored in Vault KV secrets engine, which is meant to handle arbitrary secrets:
- ACL Bootstrap token ([`global.acls.bootstrapToken`](/docs/k8s/helm#v-global-acls-bootstraptoken))
- Gossip encryption key ([`global.gossipEncryption`]())
- Enterprise license ([`global.enterpriseLicense`]())
- ACL Replication token ([`global.acls.replicationToken`](/docs/k8s/helm#v-global-acls-replicationtoken))
- Snapshot Agent config ([`client.snapshotAgent.configSecret`](/docs/k8s/helm#v-client-snapshotagent-configsecret))

In order to store any of these secrets, we must enable the [Vault KV secrets engine - Version 2](https://www.vaultproject.io/docs/secrets/kv/kv-v2).

```shell-session
$ vault secrets enable -path=consul kv-v2
```

### Vault PKI Engine

The Vault PKI Engine must be enabled in order to leverage Vault for issuing Consul Server TLS certificates. More details for configuring the PKI Engine is found in [Bootstrapping the PKI Engine](/docs/k8s/installation/vault/data-integration/server-tls#bootstrapping-the-pki-engine) under the Server TLS section.

```shell-session
$ vault secrets enable pki
```

## Set up per Consul datacenter
### Set Environment Variables to ensure integration consistency
Before installing the Vault Injector and configure the Vault KubernetesAuth Method, some environment variables need to be set to better ensure consistent mapping between Vault and Consul on Kubernetes
#### DATACENTER
  - **Recommended value:** value of `global.datacenter` in you helm values file.
    ```shell
    $ export DATACENTER=dc1
    ```
#### VAULT_AUTH_METHOD_NAME 
  - **Recommended value:** a concatentation of a `kubernetes-` prefix (to denote the auth method type) with `DATACENTER` environment variable.
    ```shell
    export VAULT_AUTH_METHOD_NAME=kubernetes-${DATACENTER}
    ```
#### VAULT_SERVER_HOST
  - **Recommended value:** find the external IP address of your Vault cluster. 
    - If Vault is install in a Kubernetes cluster, get the external IP or DNS name of the Vault server load balancer. 
      - On GKE or AKS, it'll be an IP:
        ```shell
        $ export VAULT_SERVER_HOST=$(kubectl get svc vault-dc1 -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
        ```
      - On EKS, it'll be a hostname:
        ```shell
        $ export VAULT_SERVER_HOST=$(kubectl get svc vault-dc1 -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
        ```
    - If Vault is not running on Kubernetes, <TO DO: HOW DO WE DESCRIBE HOW TO GET THIS?>
        ```shell
        $ export VAULT_SERVER_HOST=<external IP for vault cluster>
        ```
#### VAULT_ADDR
  - **Recommended value:** Connecting to Port 8200 of 
    ```shell
    $ export VAULT_ADDR=http://${VAULT_SERVER_HOST}:8200
    ```

### Install Vault Injector in your Consul k8s cluster
A minimal valid installation of Vault Kubernetes must include the Agent Injector which is utilized for accessing secrets from Vault. Vault servers could be deployed external to Vault on Kubernetes as described via the `externalvaultaddr` value in the Vault Helm Configuration.

```shell
$ cat <<EOF >> vault-injector.yaml
# vault-injector.yaml
server:
  enabled: false
injector:
  enabled: true
  externalVaultAddr: ${VAULT_ADDR}
  authPath: auth/${VAULT_AUTH_METHOD_NAME}
EOF
``` 

```shell
$ helm install vault-${DATACENTER} -f vault-injector.yaml hashicorp/vault --wait
```

### Configure the Kubernetes Auth Method in Vault for the data center

#### Enable the Auth Method
Ensure that the Vault Kubernetes.
```shell
$ vault auth enable -path=kubernetes-${DATACENTER} kubernetes
```

#### Configure Auth Method with JWT token of service account

After enabling the Kubernetes auth method, in Vault, ensure that you have configured the Kubernetes Auth method properly as described in [Kubernetes Auth Method Configuration](https://www.vaultproject.io/docs/auth/kubernetes#configuration). 

First, while targeting your Consul cluster, get the externally reachable address of the Consul Kubernetes cluster.

```
$ export KUBE_API_URL=$(kubectl config view -o jsonpath="{.clusters[?(@.name == \"$(kubectl config current-context)\")].cluster.server}")
```

Next, you will configure the Vault Kubernetes Auth Method for the data center.  You will need to provide it with:
- token_reviewer_jwt - this a JWT token from the Consul data center cluster that the Vault Kubernetes Auth Method will use to query the Consul data center Kubernetes API when services in the Consul data center request data from Vault.
- kubernetes_host - this is the URL of the Consul data center's Kubernetes API that Vault will query to authenticate the service account of an incoming request from a Consul data ceneter kubernetes service.
- kubernetes_ca_cert - this is the CA certifcation that is currently being used by the Consul data center Kubernetes cluster.

```shell-session
$ vault write auth/kubernetes/config \
    token_reviewer_jwt="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
    kubernetes_host="https://$KUBE_API_URL:443" \
    kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
```

#### Enable Vault as the secrets backend in the Consul data center
Finally, you will configure the Consul on Kubernetes helm chart for the data center to expect to receive the following values (if you have configured them) to be retreived from Vault:
- ACL Bootstrap token ([`global.acls.bootstrapToken`](/docs/k8s/helm#v-global-acls-bootstraptoken))
- Gossip encryption key ([`global.gossipEncryption`]())
- Enterprise license ([`global.enterpriseLicense]())
- ACL Replication token ([`global.acls.replicationToken`](/docs/k8s/helm#v-global-acls-replicationtoken))
- Snapshot Agent config ([`client.snapshotAgent.configSecret`](/docs/k8s/helm#v-client-snapshotagent-configsecret))
- TLS CA certificates ([`global.tls.caCert`](/docs/k8s/helm#v-global-tls-cacert))
- Server TLS certificates ([`server.serverCert`](/docs/k8s/helm#v-server-servercert))

<CodeBlockConfig filename="values.yaml">

```yaml
global:
  secretsBackend:
    vault:
      enabled: true
```

</CodeBlockConfig>

## Next Steps

As a next step, please proceed to Vault integration with Consul on Kubernetes' [Data Integration](/docs/k8s/installation/vault/data-integration).

## Troubleshooting

The Vault integration with Consul on Kubernetes makes use of the Vault Agent Injectors. Kubernetes annotations are added to the
deployments of the Consul components which cause the Vault Agent Injector to be added as an init-container that will then attach
Vault secrets to Consul's pods at startup. Additionally the Vault Agent sidecar is added to the Consul component pods which
is responsible for synchronizing and reissuing secrets at runtime.
As a result of these additional sidecar containers the typical location for logging is expanded in the Consul components.

As a general rule the best way to troubleshoot startup issues for your Consul installation when using the Vault integration
is to establish if the `vault-agent-init` container has completed or not via `kubectl logs -f <your-consul-component> -c vault-agent-int`
and checking to see if the secrets have completed rendering.
* If the secrets are not properly rendered the underlying problem will be logged in `vault-agent-init` init-container
  and generally is related to the Vault Kube Auth Role not having the correct policies for the specific secret
  e.g. `global.secretsBackend.vault.consulServerRole` not having the correct policies for TLS.
* If the secrets are rendered and the `vault-agent-init` container has completed AND the Consul component has not become `Ready`,
  this generally points to an issue with Consul being unable to utilize the Vault secret. This can occur if, for example, the Vault Role
  created for the PKI engine does not have the correct `alt_names` or otherwise is not properly configured. The best logs for this
  circumstance are the Consul container logs: `kubectl logs -f <your-consul-component> -c consul`.
