---
layout: docs
page_title: Vault as Secrets Backend Data Integration Overview
description: >-
  Overview of the data integration aspects to using Vault as secrets backend for Consul on Kubernetes.
---

# Vault as the secrets backend - Data Integration

## Pre-requisites
Prior to setting up the data integration between Vault and Consul on Kubernetes, you will need to have read and completed the steps in the [Systems Integration](/docs/k8s/installation/vault/systems-integration) section of [Vault as a Secrets Backend](/docs/k8s/installation/vault).

## Overview
Generally, for each secret you wish to store in Vault, the process to integrate the date between Vault and Consul on Kubernetes is: 
- One time set up in Vault
  1. Store the secret in Vault.
  1. Create a Vault policy that authorizes the desired level of access to the secret.
- Set up per Consul data center
  1. Create Vault Kubernetes auth roles that link the policy to each Consul on Kubernetes service account that requires access.
  1. Configure the Vault Kubernetes auth role in the Consul on Kubernetes helm chart.

For example, at a high level, the steps for [Gossip encryption key](/docs/k8s/installation/vault/data-integration/gossip) would be:
- One time set up in Vault
  1. Store the secret in Vault.
      - You save the gossip encryption key in Vault at the path `secret/consul/gossip`.
  1. Create a Vault policy that authorizes the desired level of access to the secret.
      - You create a Vault policy that you name `gossip-policy` which allows `read` access to the path `secret/consul/gossip`.
- Set up per Consul datacenter
  1. Create Vault Kubernetes auth roles that link the policy to each Consul on Kubernetes service account that requires access.
      - Both Consul servers and Consul clients need access to the gossip encryption key, so you create two Vault Kubernetes:
        - A role called `consul-server` that maps the Kubernetes namespace and service account name for your consul servers to the `gossip-policy` created in step 2.
        - A role called `consul-client` that maps the Kubernetes namespace and service account name for your consul clients to the `gossip-policy` created in step 2.
  1. Configure the Vault Kubernetes auth role in the Consul on Kubernetes helm chart.
      - You configure the Vault Kubernetes auth roles created for the gossip encryption key:
        - [`global.secretsBackend.vault.consulServerRole`](/docs/k8s/helm#v-global-secretsbackend-vault-consulserverrole) is set to the `consul-server` Vault Kubernetesauth role created previously.
        - [`global.secretsBackend.vault.consulClientRole`](/docs/k8s/helm#v-global-secretsbackend-vault-consulclientrole) is set to the `consul-client` Vault Kubernetesauth role created previously.

## Secrets to Service Account Mapping 
At the most basic level, the goal of this configuration is to authorize a Consul on Kubernetes service account to access a secret in Vault. 
Below is a mapping of Vault secrets and the Consul on Kubernetes service accounts that need to access them. 
(NOTE: `Consul components` refers to all other services and jobs that are not Consul servers or clients. 
It includes things like terminating gateways, ingress gateways, etc.)

| Secret | Service Account For | Configurable Role in Consul k8s Helm |
| ------ | ------------------- | ------------------------------------ |
|[ACL Bootstrap token](/docs/k8s/installation/vault/data-integration/bootstrap-token) | Consul server-acl-init job | [`global.secretsBackend.vault.manageSystemACLsRole`](/docs/k8s/helm#v-global-secretsbackend-vault-managesystemaclsrole)|
|[Gossip encryption key](/docs/k8s/installation/vault/data-integration/gossip) | Consul servers<br/>Consul clients | [`global.secretsBackend.vault.consulServerRole`](/docs/k8s/helm#v-global-secretsbackend-vault-consulserverrole)<br/>[`global.secretsBackend.vault.consulClientRole`](/docs/k8s/helm#v-global-secretsbackend-vault-consulclientrole)|
|[Enterprise license](/docs/k8s/installation/vault/data-integration/enterprise-license) | Consul servers<br/>Consul clients | [`global.secretsBackend.vault.consulServerRole`](/docs/k8s/helm#v-global-secretsbackend-vault-consulserverrole)<br/>[`global.secretsBackend.vault.consulClientRole`](/docs/k8s/helm#v-global-secretsbackend-vault-consulclientrole)|
|[ACL Replication token](/docs/k8s/installation/vault/data-integration/replication-token) | Consul server-acl-init job | [`global.secretsBackend.vault.manageSystemACLsRole`](/docs/k8s/helm#v-global-secretsbackend-vault-managesystemaclsrole)|
|[Snapshot Agent config](/docs/k8s/installation/vault/data-integration/snapshot-agent-config) | Consul snapshot agent | [`global.secretsBackend.vault.consulSnapshotAgentRole`](/docs/k8s/helm#v-global-secretsbackend-vault-consulsnapshotagentrole)|
|[Consul Server TLS credentials](/docs/k8s/installation/vault/data-integration/server-tls) | Consul servers<br/>Consul clients<br/>Consul components | [`global.secretsBackend.vault.consulServerRole`](/docs/k8s/helm#v-global-secretsbackend-vault-consulserverrole)<br/>[`global.secretsBackend.vault.consulClientRole`](/docs/k8s/helm#v-global-secretsbackend-vault-consulclientrole)<br/>[`global.secretsBackend.vault.consulCARole`](/docs/k8s/helm#v-global-secretsbackend-vault-consulcarole)|
|[Service Mesh and Consul client TLS credentials](/docs/k8s/installation/vault/data-integration/connect-ca) | Consul servers | [`global.secretsBackend.vault.consulServerRole`](/docs/k8s/helm#v-global-secretsbackend-vault-consulserverrole)|

### Combining policies within roles
As you can see in the table above, depending upon your needs, a Consul on Kubernetes service account could have the need to request more than one secret.  In these cases, you will want to create one role for the Consul on Kubernetes service account that is mapped to multiple policies, each of which allows it access to a given secret.  For example, if your Consul on Kubernetes servers need access to [Gossip encryption key](/docs/k8s/installation/vault/data-integration/gossip), [Consul Server TLS credentials](/docs/k8s/installation/vault/data-integration/server-tls), and [Enterprise license](/docs/k8s/installation/vault/data-integration/enterprise-license), assuming you have already saved the secrets in vault, you would:
1. Create a policy for each secret.
    * Gossip encryption key

    <CodeBlockConfig filename="gossip-policy.hcl">

    ```HCL
    path "secret/data/consul/gossip" {
      capabilities = ["read"]
    }
    ```

    </CodeBlockConfig>

    ```shell-session
    $ vault policy write gossip-policy gossip-policy.hcl
    ```

    * Consul Server TLS credentials

    <CodeBlockConfig filename="ca-policy.hcl">

    ```HCL
    path "pki/cert/ca" {
      capabilities = ["read"]
    }
    ```

    </CodeBlockConfig>

    ```shell-session
    $ vault policy write ca-policy ca-policy.hcl
    ```

    * Enterprise License

    <CodeBlockConfig filename="license-policy.hcl">

    ```HCL
    path "secret/data/consul/license" {
      capabilities = ["read"]
    }
    ```

    </CodeBlockConfig>

    ```shell-session
    $ vault policy write license-policy license-policy.hcl
    ```

1. Create one role that maps the Consul on Kubernetes servicea account to the 3 policies.
    ```shell-session
    $ vault write auth/kubernetes/role/consul-server \
        bound_service_account_names=<Consul server service account> \
        bound_service_account_namespaces=<Consul installation namespace> \
        policies=gossip-policy,ca-policy,license-policy \
        ttl=1h
    ```

## Detailed data integration guides
The following secrets can be stored in Vault KV secrets engine, which is meant to handle arbitraty secrets:
- [ACL Bootstrap token](/docs/k8s/installation/vault/data-integration/bootstrap-token)
- [Gossip encryption key](/docs/k8s/installation/vault/data-integration/gossip)
- [Enterprise license](/docs/k8s/installation/vault/data-integration/enterprise-license)
- [ACL Replication token](/docs/k8s/installation/vault/data-integration/replication-token)
- [Snapshot Agent config](/docs/k8s/installation/vault/data-integration/snapshot-agent-config)

The following TLS certificates and keys can generated and managed by Vault the Vault PKI Engine, which is meant to handle things like certificate expiration and rotation:
- [Consul Server TLS credentials](/docs/k8s/installation/vault/data-integration/server-tls)
- [Service Mesh and Consul client TLS credentials](/docs/k8s/installation/vault/data-integration/connect-ca)

## Secrets to Service Account Mapping
Read through the [detailed data integration guides](#detailed-data-integration-guides) that are pertinent to your environment.
